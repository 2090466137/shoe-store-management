var Se=Object.defineProperty,we=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var te=Object.getOwnPropertySymbols;var ke=Object.prototype.hasOwnProperty,Ae=Object.prototype.propertyIsEnumerable;var ae=(n,c,u)=>c in n?Se(n,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):n[c]=u,se=(n,c)=>{for(var u in c||(c={}))ke.call(c,u)&&ae(n,u,c[u]);if(te)for(var u of te(c))Ae.call(c,u)&&ae(n,u,c[u]);return n},le=(n,c)=>we(n,he(c));var F=(n,c,u)=>new Promise((k,N)=>{var A=y=>{try{w(u.next(y))}catch(T){N(T)}},L=y=>{try{w(u.throw(y))}catch(T){N(T)}},w=y=>y.done?k(y.value):Promise.resolve(y.value).then(A,L);w((u=u.apply(n,c)).next())});import{H as Le,r as f,k as U,C as W,T as j,_ as Oe,o as Re,c as C,d as l,b as o,n as m,w as v,e as E,l as H,a as Ce,t as S,m as b,f as G,F as ne,p as oe,g as _,s as be}from"./index.CtZro4Eu.js";const Ue=Le("operationLog",()=>{const n=f([]),c=f(!1),u={PRODUCT_ADD:"product_add",PRODUCT_UPDATE:"product_update",PRODUCT_DELETE:"product_delete",PRODUCT_STOCK_IN:"product_stock_in",PRODUCT_STOCK_OUT:"product_stock_out",SALE_ADD:"sale_add",SALE_DELETE:"sale_delete",PURCHASE_ADD:"purchase_add",PURCHASE_DELETE:"purchase_delete",RETURN_ADD:"return_add",RETURN_DELETE:"return_delete",EXCHANGE_ADD:"exchange_add",MEMBER_ADD:"member_add",MEMBER_UPDATE:"member_update",MEMBER_DELETE:"member_delete",MEMBER_RECHARGE:"member_recharge",MEMBER_CONSUME:"member_consume",USER_LOGIN:"user_login",USER_LOGOUT:"user_logout",USER_ADD:"user_add",USER_UPDATE:"user_update",USER_DELETE:"user_delete",USER_PASSWORD_CHANGE:"user_password_change",SYSTEM_BACKUP:"system_backup",SYSTEM_RESTORE:"system_restore",SYSTEM_EXPORT:"system_export"},k={product_add:"添加商品",product_update:"修改商品",product_delete:"删除商品",product_stock_in:"商品入库",product_stock_out:"商品出库",sale_add:"新增销售",sale_delete:"删除销售",purchase_add:"新增进货",purchase_delete:"删除进货",return_add:"新增退货",return_delete:"删除退货",exchange_add:"新增换货",member_add:"添加会员",member_update:"修改会员",member_delete:"删除会员",member_recharge:"会员充值",member_consume:"会员消费",user_login:"用户登录",user_logout:"用户登出",user_add:"添加用户",user_update:"修改用户",user_delete:"删除用户",user_password_change:"修改密码",system_backup:"系统备份",system_restore:"系统恢复",system_export:"数据导出"},N=t=>({id:t.id,operationType:t.operation_type,operationLabel:k[t.operation_type]||"未知操作",userId:t.user_id,username:t.username,targetType:t.target_type,targetId:t.target_id,targetName:t.target_name,details:t.details,oldValue:t.old_value,newValue:t.new_value,ipAddress:t.ip_address,userAgent:t.user_agent,createTime:new Date(t.created_at).getTime()}),A=t=>({operation_type:t.operationType,user_id:t.userId,username:t.username,target_type:t.targetType||null,target_id:t.targetId||null,target_name:t.targetName||null,details:t.details||null,old_value:t.oldValue||null,new_value:t.newValue||null,ip_address:t.ipAddress||null,user_agent:t.userAgent||null}),L=()=>{try{localStorage.setItem("operationLogs",JSON.stringify(n.value))}catch(t){console.error("❌ 保存操作日志到本地失败:",t)}},w=()=>{try{const t=localStorage.getItem("operationLogs");if(t){const r=JSON.parse(t);return Array.isArray(r)?r:[]}}catch(t){console.error("❌ 从本地加载操作日志失败:",t)}return[]},y=(...r)=>F(void 0,[...r],function*(t={}){c.value=!0;try{const{data:i,error:p}=yield W.from(j.OPERATION_LOGS).select("*").order("created_at",{ascending:!1}).limit(t.limit||1e3);if(p)return console.error("❌ 从云端加载操作日志失败:",p),n.value=w(),!1;const R=i.map(N),z=w(),B=[...R],q=new Set(R.map(P=>P.id));return z.forEach(P=>{q.has(P.id)||B.push(P)}),n.value=B.sort((P,J)=>J.createTime-P.createTime),L(),console.log(`✅ 已加载 ${n.value.length} 条操作日志`),!0}catch(i){return console.error("❌ 加载操作日志失败:",i),n.value=w(),!1}finally{c.value=!1}}),T=t=>F(void 0,null,function*(){try{const r=JSON.parse(localStorage.getItem("currentUser")||"{}"),i=navigator.userAgent,p={id:`log_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,operationType:t.operationType,userId:r.id||"unknown",username:r.username||"未知用户",targetType:t.targetType||null,targetId:t.targetId||null,targetName:t.targetName||null,details:t.details||null,oldValue:t.oldValue||null,newValue:t.newValue||null,ipAddress:null,userAgent:i,createTime:Date.now()};n.value.unshift(p),L();try{const R=A(p),{data:z,error:B}=yield W.from(j.OPERATION_LOGS).insert([le(se({},R),{id:p.id})]).select();B?console.warn("⚠️ 保存操作日志到云端失败:",B):console.log("✅ 操作日志已同步到云端")}catch(R){console.warn("⚠️ 云端保存失败，仅保存到本地:",R)}return!0}catch(r){return console.error("❌ 添加操作日志失败:",r),!1}}),$=(t=90)=>F(void 0,null,function*(){try{const r=Date.now()-t*24*60*60*1e3;n.value=n.value.filter(R=>R.createTime>=r),L();const i=new Date(r).toISOString(),{error:p}=yield W.from(j.OPERATION_LOGS).delete().lt("created_at",i);return p?(console.error("❌ 清理云端旧日志失败:",p),!1):(console.log(`✅ 已清理 ${t} 天前的操作日志`),!0)}catch(r){return console.error("❌ 清理旧日志失败:",r),!1}}),O=U(()=>n.value),I=U(()=>t=>n.value.filter(r=>r.operationType===t)),h=U(()=>t=>n.value.filter(r=>r.userId===t)),d=U(()=>(t,r)=>n.value.filter(i=>i.createTime>=t&&i.createTime<=r)),K=U(()=>{const t=new Date;t.setHours(0,0,0,0);const r=t.getTime();return n.value.filter(i=>i.createTime>=r)}),X=U(()=>{const t=new Date;t.setHours(0,0,0,0);const r=t.getTime();return{total:n.value.length,today:n.value.filter(i=>i.createTime>=r).length,byType:n.value.reduce((i,p)=>(i[p.operationType]=(i[p.operationType]||0)+1,i),{})}});return{logs:n,loading:c,OPERATION_TYPES:u,OPERATION_TYPE_LABELS:k,loadLogs:y,addLog:T,clearOldLogs:$,getAllLogs:O,getLogsByType:I,getLogsByUser:h,getLogsByDateRange:d,todayLogs:K,stats:X}}),Ne={class:"operation-logs-page page-container"},$e={class:"stats-card"},Pe={class:"stat-item"},Ie={class:"stat-value"},Ve={class:"stat-item"},Me={class:"stat-value"},Be={class:"stat-item"},xe={class:"stat-value"},Fe={key:0,class:"filter-tags"},He={class:"content-wrapper"},Ge=["onClick"],ze={class:"log-header"},Je={class:"log-type"},Ye={class:"log-time"},Ke={class:"log-content"},Xe={class:"log-user"},qe={key:0,class:"log-target"},We={key:1,class:"log-details"},je={class:"filter-popup"},Qe={class:"popup-header"},Ze={class:"filter-content"},et={key:0,class:"detail-popup"},tt={class:"popup-header"},at={class:"detail-content"},st={class:"value-compare"},lt={key:0,class:"old-value"},nt={key:1,class:"new-value"},ot=20,rt={__name:"OperationLogs",setup(n){const c=Ce(),u=Ue(),k=f(!1),N=f(!1),A=f(!1),L=f(!1),w=f(!1),y=f(!1),T=f(""),$=f(""),O=f([]),I=f(""),h=f([]),d=f(null),K=new Date(2020,0,1),X=new Date,t={product_add:"添加商品",product_update:"修改商品",product_delete:"删除商品",sale_add:"新增销售",sale_delete:"删除销售",purchase_add:"新增进货",purchase_delete:"删除进货",return_add:"新增退货",member_recharge:"会员充值",user_login:"用户登录"},r=U(()=>{let a=u.getAllLogs;if(T.value&&(a=a.filter(e=>e.operationType===T.value)),$.value&&(a=a.filter(e=>e.username===$.value)),O.value.length===2){const[e,D]=O.value;a=a.filter(V=>V.createTime>=e.getTime()&&V.createTime<=D.getTime()+24*60*60*1e3-1)}return a}),i=f(1),p=U(()=>r.value.slice(0,i.value*ot)),R=U(()=>T.value||$.value||O.value.length>0),z=U(()=>new Set(u.getAllLogs.map(e=>e.userId)).size),B=a=>{const e=new Date(a),D=new Date,V=D-e;if(V<6e4)return"刚刚";if(V<36e5)return`${Math.floor(V/6e4)}分钟前`;if(e.toDateString()===D.toDateString())return e.toTimeString().slice(0,5);const M=new Date(D);return M.setDate(M.getDate()-1),e.toDateString()===M.toDateString()?`昨天 ${e.toTimeString().slice(0,5)}`:`${e.getMonth()+1}-${e.getDate()} ${e.toTimeString().slice(0,5)}`},q=a=>{const e=new Date(a);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${e.toTimeString().slice(0,8)}`},P=(a=O.value)=>{if(a.length!==2)return"";const[e,D]=a;return`${e.getMonth()+1}/${e.getDate()} - ${D.getMonth()+1}/${D.getDate()}`},J=a=>{try{return JSON.stringify(typeof a=="string"?JSON.parse(a):a,null,2)}catch(e){return a}},re=a=>a.includes("add")?"success":a.includes("delete")?"danger":a.includes("update")?"warning":a.includes("login")?"primary":"default",ue=()=>F(this,null,function*(){N.value=!0,yield u.loadLogs(),i.value=1,A.value=!1,N.value=!1,be("刷新成功")}),ie=()=>{if(p.value.length>=r.value.length){A.value=!0;return}setTimeout(()=>{i.value++,k.value=!1,p.value.length>=r.value.length&&(A.value=!0)},500)},de=()=>{T.value=I.value,O.value=[...h.value],L.value=!1,i.value=1,A.value=!1},ce=()=>{T.value="",$.value="",O.value=[],I.value="",h.value=[],i.value=1,A.value=!1},ve=a=>{h.value=a,w.value=!1},_e=()=>{const a=new Date;a.setHours(0,0,0,0),h.value=[a,new Date]},pe=()=>{const a=new Date,e=new Date;e.setDate(e.getDate()-7),e.setHours(0,0,0,0),h.value=[e,a]},me=()=>{const a=new Date,e=new Date;e.setDate(e.getDate()-30),e.setHours(0,0,0,0),h.value=[e,a]},ge=a=>{d.value=a,y.value=!0};return Re(()=>F(this,null,function*(){k.value=!0,yield u.loadLogs(),k.value=!1})),(a,e)=>{const D=E("van-icon"),V=E("van-nav-bar"),M=E("van-tag"),Q=E("van-button"),fe=E("van-empty"),ye=E("van-list"),Te=E("van-pull-refresh"),Z=E("van-radio"),g=E("van-cell"),De=E("van-radio-group"),x=E("van-cell-group"),ee=E("van-popup"),Ee=E("van-calendar");return _(),C("div",Ne,[l(V,{title:"操作日志","left-arrow":"",onClickLeft:e[1]||(e[1]=s=>H(c).back())},{right:v(()=>[l(D,{name:"filter-o",size:"22",onClick:e[0]||(e[0]=s=>L.value=!0)})]),_:1}),o("div",$e,[o("div",Pe,[o("div",Ie,S(H(u).stats.total),1),e[15]||(e[15]=o("div",{class:"stat-label"},"总日志数",-1))]),o("div",Ve,[o("div",Me,S(H(u).stats.today),1),e[16]||(e[16]=o("div",{class:"stat-label"},"今日操作",-1))]),o("div",Be,[o("div",xe,S(z.value),1),e[17]||(e[17]=o("div",{class:"stat-label"},"操作人数",-1))])]),R.value?(_(),C("div",Fe,[T.value?(_(),b(M,{key:0,closeable:"",type:"primary",onClose:e[2]||(e[2]=s=>T.value="")},{default:v(()=>[G(S(H(u).OPERATION_TYPE_LABELS[T.value]),1)]),_:1})):m("",!0),$.value?(_(),b(M,{key:1,closeable:"",type:"success",onClose:e[3]||(e[3]=s=>$.value="")},{default:v(()=>[G(S($.value),1)]),_:1})):m("",!0),O.value.length>0?(_(),b(M,{key:2,closeable:"",type:"warning",onClose:e[4]||(e[4]=s=>O.value=[])},{default:v(()=>[G(S(P()),1)]),_:1})):m("",!0),l(Q,{size:"small",type:"danger",plain:"",onClick:ce},{default:v(()=>[...e[18]||(e[18]=[G(" 清除全部 ",-1)])]),_:1})])):m("",!0),o("div",He,[l(Te,{modelValue:N.value,"onUpdate:modelValue":e[6]||(e[6]=s=>N.value=s),onRefresh:ue},{default:v(()=>[l(ye,{loading:k.value,"onUpdate:loading":e[5]||(e[5]=s=>k.value=s),finished:A.value,"finished-text":"没有更多了",onLoad:ie},{default:v(()=>[(_(!0),C(ne,null,oe(p.value,s=>(_(),C("div",{key:s.id,class:"log-item",onClick:Y=>ge(s)},[o("div",ze,[o("div",Je,[l(M,{type:re(s.operationType)},{default:v(()=>[G(S(s.operationLabel),1)]),_:2},1032,["type"])]),o("div",Ye,S(B(s.createTime)),1)]),o("div",Ke,[o("div",Xe,[l(D,{name:"user-o"}),o("span",null,S(s.username),1)]),s.targetName?(_(),C("div",qe,[l(D,{name:"label-o"}),o("span",null,S(s.targetName),1)])):m("",!0),s.details?(_(),C("div",We,S(s.details),1)):m("",!0)])],8,Ge))),128)),p.value.length===0&&!k.value?(_(),b(fe,{key:0,description:"暂无操作日志"})):m("",!0)]),_:1},8,["loading","finished"])]),_:1},8,["modelValue"])]),l(ee,{show:L.value,"onUpdate:show":e[11]||(e[11]=s=>L.value=s),position:"bottom",style:{height:"60%"},round:""},{default:v(()=>[o("div",je,[o("div",Qe,[e[20]||(e[20]=o("span",{class:"popup-title"},"筛选条件",-1)),l(Q,{type:"primary",size:"small",onClick:de},{default:v(()=>[...e[19]||(e[19]=[G(" 应用 ",-1)])]),_:1})]),o("div",Ze,[l(x,{title:"操作类型",inset:""},{default:v(()=>[l(De,{modelValue:I.value,"onUpdate:modelValue":e[8]||(e[8]=s=>I.value=s)},{default:v(()=>[l(g,{title:"全部",clickable:"",onClick:e[7]||(e[7]=s=>I.value="")},{"right-icon":v(()=>[l(Z,{name:"","icon-size":"20px"})]),_:1}),(_(),C(ne,null,oe(t,(s,Y)=>l(g,{key:Y,title:s,clickable:"",onClick:ut=>I.value=Y},{"right-icon":v(()=>[l(Z,{name:Y,"icon-size":"20px"},null,8,["name"])]),_:2},1032,["title","onClick"])),64))]),_:1},8,["modelValue"])]),_:1}),l(x,{title:"日期范围",inset:""},{default:v(()=>[l(g,{title:"选择日期范围",value:h.value.length>0?P(h.value):"全部","is-link":"",onClick:e[9]||(e[9]=s=>w.value=!0)},null,8,["value"]),h.value.length>0?(_(),b(g,{key:0,title:"清除日期筛选","is-link":"",onClick:e[10]||(e[10]=s=>h.value=[])})):m("",!0)]),_:1}),l(x,{title:"快捷选择",inset:""},{default:v(()=>[l(g,{title:"今天","is-link":"",onClick:_e}),l(g,{title:"最近7天","is-link":"",onClick:pe}),l(g,{title:"最近30天","is-link":"",onClick:me})]),_:1})])])]),_:1},8,["show"]),l(Ee,{show:w.value,"onUpdate:show":e[12]||(e[12]=s=>w.value=s),type:"range",onConfirm:ve,"min-date":H(K),"max-date":H(X)},null,8,["show","min-date","max-date"]),l(ee,{show:y.value,"onUpdate:show":e[14]||(e[14]=s=>y.value=s),position:"bottom",style:{height:"70%"},round:""},{default:v(()=>[d.value?(_(),C("div",et,[o("div",tt,[e[21]||(e[21]=o("span",{class:"popup-title"},"操作详情",-1)),l(D,{name:"cross",onClick:e[13]||(e[13]=s=>y.value=!1)})]),o("div",at,[l(x,{inset:""},{default:v(()=>[l(g,{title:"操作类型",value:d.value.operationLabel},null,8,["value"]),l(g,{title:"操作人",value:d.value.username},null,8,["value"]),l(g,{title:"操作时间",value:q(d.value.createTime)},null,8,["value"]),d.value.targetName?(_(),b(g,{key:0,title:"操作对象",value:d.value.targetName},null,8,["value"])):m("",!0),d.value.details?(_(),b(g,{key:1,title:"操作详情",label:d.value.details},null,8,["label"])):m("",!0)]),_:1}),d.value.oldValue||d.value.newValue?(_(),b(x,{key:0,title:"数据变更",inset:""},{default:v(()=>[o("div",st,[d.value.oldValue?(_(),C("div",lt,[e[22]||(e[22]=o("div",{class:"value-label"},"修改前：",-1)),o("pre",null,S(J(d.value.oldValue)),1)])):m("",!0),d.value.newValue?(_(),C("div",nt,[e[23]||(e[23]=o("div",{class:"value-label"},"修改后：",-1)),o("pre",null,S(J(d.value.newValue)),1)])):m("",!0)])]),_:1})):m("",!0),l(x,{title:"技术信息",inset:""},{default:v(()=>[d.value.ipAddress?(_(),b(g,{key:0,title:"IP地址",value:d.value.ipAddress},null,8,["value"])):m("",!0),d.value.userAgent?(_(),b(g,{key:1,title:"浏览器",label:d.value.userAgent},null,8,["label"])):m("",!0),l(g,{title:"日志ID",value:d.value.id},null,8,["value"])]),_:1})])])):m("",!0)]),_:1},8,["show"])])}}},ct=Oe(rt,[["__scopeId","data-v-8cf8db2c"]]);export{ct as default};
