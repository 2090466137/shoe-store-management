var x=(R,S,m)=>new Promise((w,b)=>{var c=l=>{try{u(m.next(l))}catch(_){b(_)}},h=l=>{try{u(m.throw(l))}catch(_){b(_)}},u=l=>l.done?w(l.value):Promise.resolve(l.value).then(c,h);u((m=m.apply(R,S)).next())});import{_ as se,B as oe,j as ae,r as d,k,o as ne,c as v,d as n,b as t,w as g,e as y,l as E,a as le,t as r,n as D,F as L,p as j,f as z,C as ie,T as re,g as p,v as G}from"./index-Dd-o1vNh.js";const de={class:"member-history-page page-container"},ue={class:"content-wrapper"},me={class:"stats-card card"},ve={class:"stats-grid"},pe={class:"stats-item"},ce={class:"stats-value success"},_e={class:"stats-item"},fe={class:"stats-value primary"},ye={class:"stats-item"},be={class:"stats-value"},he={class:"stats-item"},ge={class:"stats-value"},ke={class:"filter-tabs"},we={class:"history-list"},Ce={key:0,class:"empty-state"},Me={class:"history-header"},$e={class:"history-time"},De={class:"history-content"},Se={class:"history-member"},Ve={class:"member-name"},Te={class:"member-phone"},xe={key:0,class:"history-footer"},Re={key:0,class:"history-payment"},Fe={key:1,class:"history-notes"},Ie={class:"filter-popup"},Ae={class:"filter-header"},Be={class:"filter-content"},He={class:"filter-section"},Ne={class:"filter-section"},Pe={class:"filter-actions"},Ue={class:"picker-popup"},Ee={class:"picker-header"},Le={class:"picker-content"},je=["onClick"],ze={class:"member-picker-info"},Ge={class:"member-picker-name"},Ye={class:"member-picker-phone"},qe={class:"popup-header"},Je={__name:"MemberHistory",setup(R){const S=le(),m=oe(),w=ae(),b=d("all"),c=d(!1),h=d(!1),u=d(!1),l=d(null),_=d("å…¨éƒ¨ä¼šå‘˜"),f=d(null),C=d("å…¨éƒ¨æ—¥æœŸ"),F=d(new Date),I=d([]),A=d([]),B=d(!1),Y=()=>x(this,null,function*(){try{const{data:s,error:e}=yield ie.from(re.MEMBER_RECHARGES).select("*").order("created_at",{ascending:!1});if(e){console.error("åŠ è½½å……å€¼è®°å½•å¤±è´¥:",e);return}I.value=s.map(a=>{const i=m.getMemberById(a.member_id);return{id:a.id,type:"recharge",memberId:a.member_id,memberName:(i==null?void 0:i.name)||"æœªçŸ¥ä¼šå‘˜",memberPhone:(i==null?void 0:i.phone)||"",amount:parseFloat(a.amount)||0,paymentMethod:a.payment_method||"çŽ°é‡‘",notes:a.notes||"",time:new Date(a.created_at).getTime()}})}catch(s){console.error("åŠ è½½å……å€¼è®°å½•å¼‚å¸¸:",s)}}),q=()=>{A.value=w.getAllSales.filter(s=>s.memberId).map(s=>{const e=m.getMemberById(s.memberId);return{id:s.id,type:"consumption",memberId:s.memberId,memberName:(e==null?void 0:e.name)||"æœªçŸ¥ä¼šå‘˜",memberPhone:(e==null?void 0:e.phone)||"",amount:s.actualAmount||s.totalAmount,paymentMethod:s.paymentMethod||"ä¼šå‘˜ä½™é¢",notes:s.remark||"",time:s.time||s.date}})},M=k(()=>{let s=I.value;if(l.value&&(s=s.filter(e=>e.memberId===l.value.id)),f.value){const e=new Date(f.value).setHours(0,0,0,0),a=new Date(f.value).setHours(23,59,59,999);s=s.filter(i=>i.time>=e&&i.time<=a)}return s}),$=k(()=>{let s=A.value;if(l.value&&(s=s.filter(e=>e.memberId===l.value.id)),f.value){const e=new Date(f.value).setHours(0,0,0,0),a=new Date(f.value).setHours(23,59,59,999);s=s.filter(i=>i.time>=e&&i.time<=a)}return s}),H=k(()=>{let s=[];return b.value==="all"?s=[...M.value,...$.value]:b.value==="recharge"?s=M.value:s=$.value,s.sort((e,a)=>a.time-e.time)}),J=k(()=>M.value.reduce((s,e)=>s+e.amount,0)),K=k(()=>$.value.reduce((s,e)=>s+e.amount,0)),O=()=>{},N=s=>{l.value=s,_.value=s?`${s.name||"æœªå‘½å"} (${s.phone})`:"å…¨éƒ¨ä¼šå‘˜",h.value=!1},Q=s=>{f.value=s;const e=new Date(s);C.value=`${e.getFullYear()}å¹´${e.getMonth()+1}æœˆ${e.getDate()}æ—¥`,u.value=!1},W=()=>{l.value=null,_.value="å…¨éƒ¨ä¼šå‘˜",f.value=null,C.value="å…¨éƒ¨æ—¥æœŸ",c.value=!1},X=()=>{c.value=!1},Z=s=>{const e=new Date(s);return`${e.getMonth()+1}/${e.getDate()} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};return ne(()=>x(this,null,function*(){B.value=!0,yield Promise.all([m.loadMembers(),w.loadSales(),Y()]),q(),B.value=!1})),(s,e)=>{const a=y("van-icon"),i=y("van-nav-bar"),V=y("van-tab"),ee=y("van-tabs"),P=y("van-field"),U=y("van-button"),T=y("van-popup"),te=y("van-datetime-picker");return p(),v("div",de,[n(i,{title:"ä¼šå‘˜åŽ†å²è®°å½•","left-arrow":"",onClickLeft:e[1]||(e[1]=o=>E(S).back())},{right:g(()=>[n(a,{name:"filter-o",onClick:e[0]||(e[0]=o=>c.value=!0)})]),_:1}),t("div",ue,[t("div",me,[t("div",ve,[t("div",pe,[e[16]||(e[16]=t("div",{class:"stats-label"},"æ€»å……å€¼",-1)),t("div",ce,"Â¥"+r(J.value.toFixed(2)),1)]),t("div",_e,[e[17]||(e[17]=t("div",{class:"stats-label"},"æ€»æ¶ˆè´¹",-1)),t("div",fe,"Â¥"+r(K.value.toFixed(2)),1)]),t("div",ye,[e[18]||(e[18]=t("div",{class:"stats-label"},"å……å€¼æ¬¡æ•°",-1)),t("div",be,r(M.value.length),1)]),t("div",he,[e[19]||(e[19]=t("div",{class:"stats-label"},"æ¶ˆè´¹æ¬¡æ•°",-1)),t("div",ge,r($.value.length),1)])])]),t("div",ke,[n(ee,{active:b.value,"onUpdate:active":e[2]||(e[2]=o=>b.value=o),onChange:O},{default:g(()=>[n(V,{title:"å…¨éƒ¨",name:"all"}),n(V,{title:"å……å€¼è®°å½•",name:"recharge"}),n(V,{title:"æ¶ˆè´¹è®°å½•",name:"consumption"})]),_:1},8,["active"])]),t("div",we,[H.value.length===0?(p(),v("div",Ce,[...e[20]||(e[20]=[t("div",{class:"empty-icon"},"ðŸ“‹",-1),t("div",{class:"empty-text"},"æš‚æ— è®°å½•",-1)])])):D("",!0),(p(!0),v(L,null,j(H.value,o=>(p(),v("div",{key:o.id,class:"history-item"},[t("div",Me,[t("span",{class:G(["history-type",o.type])},r(o.type==="recharge"?"å……å€¼":"æ¶ˆè´¹"),3),t("span",$e,r(Z(o.time)),1)]),t("div",De,[t("div",Se,[t("div",Ve,r(o.memberName),1),t("div",Te,r(o.memberPhone),1)]),t("div",{class:G(["history-amount",o.type])},r(o.type==="recharge"?"+":"-")+"Â¥"+r(o.amount.toFixed(2)),3)]),o.notes||o.paymentMethod?(p(),v("div",xe,[o.paymentMethod?(p(),v("span",Re,r(o.paymentMethod),1)):D("",!0),o.notes?(p(),v("span",Fe,r(o.notes),1)):D("",!0)])):D("",!0)]))),128))])]),n(T,{show:c.value,"onUpdate:show":e[8]||(e[8]=o=>c.value=o),position:"bottom",style:{height:"60%"}},{default:g(()=>[t("div",Ie,[t("div",Ae,[e[21]||(e[21]=t("span",{class:"filter-title"},"ç­›é€‰æ¡ä»¶",-1)),n(a,{name:"cross",onClick:e[3]||(e[3]=o=>c.value=!1)})]),t("div",Be,[t("div",He,[e[22]||(e[22]=t("div",{class:"filter-section-title"},"é€‰æ‹©ä¼šå‘˜",-1)),n(P,{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=o=>_.value=o),placeholder:"å…¨éƒ¨ä¼šå‘˜",readonly:"","is-link":"",onClick:e[5]||(e[5]=o=>h.value=!0)},null,8,["modelValue"])]),t("div",Ne,[e[23]||(e[23]=t("div",{class:"filter-section-title"},"æ—¥æœŸèŒƒå›´",-1)),n(P,{modelValue:C.value,"onUpdate:modelValue":e[6]||(e[6]=o=>C.value=o),placeholder:"å…¨éƒ¨æ—¥æœŸ",readonly:"","is-link":"",onClick:e[7]||(e[7]=o=>u.value=!0)},null,8,["modelValue"])]),t("div",Pe,[n(U,{block:"",onClick:W},{default:g(()=>[...e[24]||(e[24]=[z("é‡ç½®",-1)])]),_:1}),n(U,{type:"primary",block:"",onClick:X},{default:g(()=>[...e[25]||(e[25]=[z("ç¡®å®š",-1)])]),_:1})])])])]),_:1},8,["show"]),n(T,{show:h.value,"onUpdate:show":e[11]||(e[11]=o=>h.value=o),position:"bottom",style:{height:"50%"}},{default:g(()=>[t("div",Ue,[t("div",Ee,[e[26]||(e[26]=t("span",{class:"picker-title"},"é€‰æ‹©ä¼šå‘˜",-1)),n(a,{name:"cross",onClick:e[9]||(e[9]=o=>h.value=!1)})]),t("div",Le,[t("div",{class:"member-picker-item",onClick:e[10]||(e[10]=o=>N(null))},[...e[27]||(e[27]=[t("div",{class:"member-picker-name"},"å…¨éƒ¨ä¼šå‘˜",-1)])]),(p(!0),v(L,null,j(E(m).getAllMembers,o=>(p(),v("div",{key:o.id,class:"member-picker-item",onClick:Ke=>N(o)},[t("div",ze,[t("div",Ge,r(o.name||"æœªå‘½å"),1),t("div",Ye,r(o.phone),1)])],8,je))),128))])])]),_:1},8,["show"]),n(T,{show:u.value,"onUpdate:show":e[15]||(e[15]=o=>u.value=o),position:"bottom",round:""},{default:g(()=>[t("div",qe,[e[28]||(e[28]=t("span",null,null,-1)),e[29]||(e[29]=t("span",{class:"popup-title"},"é€‰æ‹©æ—¥æœŸ",-1)),n(a,{name:"cross",class:"popup-close",onClick:e[12]||(e[12]=o=>u.value=!1)})]),n(te,{modelValue:F.value,"onUpdate:modelValue":e[13]||(e[13]=o=>F.value=o),type:"date",onConfirm:Q,onCancel:e[14]||(e[14]=o=>u.value=!1)},null,8,["modelValue"])]),_:1},8,["show"])])}}},We=se(Je,[["__scopeId","data-v-73ed7c37"]]);export{We as default};
