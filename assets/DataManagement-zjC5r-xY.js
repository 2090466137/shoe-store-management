const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-UkLcb2kz.js","assets/index-CXJc4kdR.css"])))=>i.map(i=>d[i]);
var S=(t,a,r)=>new Promise((n,d)=>{var l=u=>{try{i(r.next(u))}catch(m){d(m)}},g=u=>{try{i(r.throw(u))}catch(m){d(m)}},i=u=>u.done?n(u.value):Promise.resolve(u.value).then(l,g);i((r=r.apply(t,a)).next())});import{C as D,T,_ as E,r as J,o as U,c as j,d as v,b as s,l as A,a as F,e as O,D as z,m as P,n as M,t as I,v as K,w as b,f as y,E as w,z as C,A as h,s as f,g as x,h as Y,G as q}from"./index-UkLcb2kz.js";function G(){try{const t=localStorage.getItem("products"),a=localStorage.getItem("sales"),r=localStorage.getItem("purchases"),n={version:"1.0.0",exportTime:new Date().toISOString(),data:{products:t?JSON.parse(t):[],sales:a?JSON.parse(a):[],purchases:r?JSON.parse(r):[]}},d=JSON.stringify(n,null,2),l=new Blob([d],{type:"application/json"}),g=URL.createObjectURL(l),i=new Date,u=`鞋店数据备份_${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}_${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}.json`,m=document.createElement("a");return m.href=g,m.download=u,m.click(),URL.revokeObjectURL(g),{success:!0,fileName:u}}catch(t){return console.error("导出数据失败:",t),{success:!1,error:t.message}}}function H(t){return new Promise((a,r)=>{const n=new FileReader;n.onload=d=>{try{const l=JSON.parse(d.target.result);if(!l.data||!l.data.products)throw new Error("备份文件格式不正确");localStorage.setItem("products",JSON.stringify(l.data.products)),localStorage.setItem("sales",JSON.stringify(l.data.sales||[])),localStorage.setItem("purchases",JSON.stringify(l.data.purchases||[])),a({success:!0,data:l,message:"数据导入成功！页面将刷新以加载新数据。"})}catch(l){r({success:!1,error:l.message})}},n.onerror=()=>{r({success:!1,error:"文件读取失败"})},n.readAsText(t)})}function Q(){try{const t=localStorage.getItem("products");if(!t)return{success:!1,error:"没有商品数据"};const a=JSON.parse(t),r=["商品名称","货号","分类","颜色","尺码","成本价","销售价","库存","最低库存","供应商"],n=a.map(c=>[c.name,c.code,c.category,c.color,c.size,c.costPrice,c.salePrice,c.stock,c.minStock,c.supplier||""]),d=[r.join(","),...n.map(c=>c.join(","))].join(`
`),l="\uFEFF",g=new Blob([l+d],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(g),u=new Date,m=`商品列表_${u.getFullYear()}${String(u.getMonth()+1).padStart(2,"0")}${String(u.getDate()).padStart(2,"0")}.csv`,k=document.createElement("a");return k.href=i,k.download=m,k.click(),URL.revokeObjectURL(i),{success:!0,fileName:m}}catch(t){return console.error("导出CSV失败:",t),{success:!1,error:t.message}}}function W(){try{const t=localStorage.getItem("sales");if(!t)return{success:!1,error:"没有销售数据"};const a=JSON.parse(t),r=["日期","商品名称","数量","单价","总额","成本价","利润"],n=a.map(c=>[new Date(c.date).toLocaleString("zh-CN"),c.productName,c.quantity,c.salePrice,c.totalAmount,c.costPrice,c.profit]),d=[r.join(","),...n.map(c=>c.join(","))].join(`
`),l="\uFEFF",g=new Blob([l+d],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(g),u=new Date,m=`销售记录_${u.getFullYear()}${String(u.getMonth()+1).padStart(2,"0")}${String(u.getDate()).padStart(2,"0")}.csv`,k=document.createElement("a");return k.href=i,k.download=m,k.click(),URL.revokeObjectURL(i),{success:!0,fileName:m}}catch(t){return console.error("导出销售记录失败:",t),{success:!1,error:t.message}}}function X(){const t=localStorage.getItem("lastBackupTime"),a=Date.now();return!t||a-parseInt(t)>24*60*60*1e3?{needBackup:!0,message:"建议备份数据，距离上次备份已超过24小时"}:{needBackup:!1}}function Z(){localStorage.setItem("lastBackupTime",Date.now().toString())}function ee(){return localStorage.removeItem("products"),localStorage.removeItem("sales"),localStorage.removeItem("purchases"),localStorage.removeItem("lastBackupTime"),{success:!0,message:"所有数据已清空"}}function te(){const t=localStorage.getItem("products"),a=localStorage.getItem("sales"),r=localStorage.getItem("purchases");return{productsCount:t?JSON.parse(t).length:0,salesCount:a?JSON.parse(a).length:0,purchasesCount:r?JSON.parse(r).length:0,lastBackupTime:localStorage.getItem("lastBackupTime")?new Date(parseInt(localStorage.getItem("lastBackupTime"))).toLocaleString("zh-CN"):"从未备份"}}function se(){return S(this,null,function*(){try{console.log("🔄 开始手动云端备份...");const t=localStorage.getItem("products"),a=localStorage.getItem("sales"),r=localStorage.getItem("purchases"),n=localStorage.getItem("members"),d=localStorage.getItem("returns"),l={version:"1.0.0",backup_time:new Date().toISOString(),device_info:navigator.userAgent,data:{products:t?JSON.parse(t):[],sales:a?JSON.parse(a):[],purchases:r?JSON.parse(r):[],members:n?JSON.parse(n):[],returns:d?JSON.parse(d):[]},stats:{products_count:t?JSON.parse(t).length:0,sales_count:a?JSON.parse(a).length:0,purchases_count:r?JSON.parse(r).length:0,members_count:n?JSON.parse(n).length:0,returns_count:d?JSON.parse(d).length:0}},{data:g,error:i}=yield D.from(T.BACKUPS).insert([{backup_data:l,backup_type:"manual",created_at:new Date().toISOString()}]).select();return i?(console.error("❌ 云端备份失败:",i),{success:!1,error:i.message}):(localStorage.setItem("lastCloudBackupTime",Date.now().toString()),localStorage.setItem("lastBackupTime",Date.now().toString()),console.log("✅ 手动云端备份成功！",g),{success:!0,data:g[0],message:"数据已成功备份到云端"})}catch(t){return console.error("❌ 云端备份异常:",t),{success:!1,error:t.message}}})}function ae(t=10){return S(this,null,function*(){try{const{data:a,error:r}=yield D.from(T.BACKUPS).select("*").order("created_at",{ascending:!1}).limit(t);return r?(console.error("❌ 获取备份列表失败:",r),{success:!1,error:r.message}):{success:!0,data:a}}catch(a){return console.error("❌ 获取备份列表异常:",a),{success:!1,error:a.message}}})}function oe(t){return S(this,null,function*(){try{console.log("🔄 开始从云端恢复数据...",t);const{data:a,error:r}=yield D.from(T.BACKUPS).select("*").eq("id",t).single();if(r)return console.error("❌ 获取备份数据失败:",r),{success:!1,error:r.message};if(!a||!a.backup_data)return{success:!1,error:"备份数据不存在"};const n=a.backup_data;return n.data.products&&localStorage.setItem("products",JSON.stringify(n.data.products)),n.data.sales&&localStorage.setItem("sales",JSON.stringify(n.data.sales)),n.data.purchases&&localStorage.setItem("purchases",JSON.stringify(n.data.purchases)),n.data.members&&localStorage.setItem("members",JSON.stringify(n.data.members)),console.log("✅ 数据恢复成功！"),{success:!0,message:"数据已从云端恢复成功！页面将刷新以加载新数据。",stats:n.stats}}catch(a){return console.error("❌ 数据恢复异常:",a),{success:!1,error:a.message}}})}const re={class:"data-management-page page-container"},ne={class:"content-wrapper"},ce={class:"card"},le={class:"stats-list"},ie={class:"stat-row"},ue={class:"stat-value"},de={class:"stat-row"},pe={class:"stat-value"},ge={class:"stat-row"},me={class:"stat-value"},fe={class:"stat-row"},ve={class:"card"},Se={class:"action-list"},he={class:"tips"},ke={class:"card"},we={class:"action-list"},be={class:"tips"},ye={class:"card"},_e={class:"action-list"},Ce={class:"tips warning"},Be={class:"card"},Ne={class:"action-list"},Oe={class:"tips danger"},Ie={__name:"DataManagement",setup(t){const a=F(),r=J(null),n=J({productsCount:0,salesCount:0,purchasesCount:0,lastBackupTime:"从未备份"}),d=J(!1);U(()=>{l(),g()});const l=()=>{n.value=te()},g=()=>{const o=X();d.value=o.needBackup},i=()=>{C({message:"正在导出...",forbidClick:!0,duration:0}),setTimeout(()=>{const o=G();h(),o.success?(Z(),l(),g(),w({title:"导出成功",message:`文件已保存：${o.fileName}

请妥善保管备份文件！`})):f({type:"fail",message:"导出失败："+o.error})},500)},u=()=>{C({message:"正在导出...",forbidClick:!0,duration:0}),setTimeout(()=>{const o=Q();h(),o.success?f({type:"success",message:"商品列表导出成功"}):f({type:"fail",message:o.error})},500)},m=()=>{C({message:"正在导出...",forbidClick:!0,duration:0}),setTimeout(()=>{const o=W();h(),o.success?f({type:"success",message:"销售记录导出成功"}):f({type:"fail",message:o.error})},500)},k=o=>S(this,null,function*(){const e=o.target.files[0];e&&w({title:"确认恢复",message:`恢复数据将覆盖当前所有数据，确定要继续吗？

建议先备份当前数据！`,showCancelButton:!0}).then(()=>S(this,null,function*(){C({message:"正在恢复数据...",forbidClick:!0,duration:0});try{const p=yield H(e);h(),p.success&&w({title:"恢复成功",message:p.message}).then(()=>{window.location.reload()})}catch(p){h(),f({type:"fail",message:"恢复失败："+p.error})}o.target.value=""})).catch(()=>{o.target.value=""})}),c=()=>{w({title:"危险操作",message:`确定要清空所有数据吗？

此操作不可恢复！

强烈建议先备份数据！`,showCancelButton:!0,confirmButtonText:"确认清空",confirmButtonColor:"#ff4d4f"}).then(()=>{w({title:"最后确认",message:`真的要清空所有数据吗？

这是最后一次确认！`,showCancelButton:!0,confirmButtonText:"确认清空",confirmButtonColor:"#ff4d4f"}).then(()=>{ee(),w({title:"清空成功",message:"所有数据已清空，页面将刷新。"}).then(()=>{window.location.reload()})}).catch(()=>{})}).catch(()=>{})},L=()=>S(this,null,function*(){C({message:"正在备份到云端...",forbidClick:!0,duration:0});try{const o=yield se();h(),o.success?(l(),g(),Y({message:"云端备份成功！",duration:2e3})):f({type:"fail",message:"备份失败："+o.error})}catch(o){h(),f({type:"fail",message:"备份失败："+o.message})}}),$=()=>S(this,null,function*(){C({message:"加载中...",forbidClick:!0,duration:0});try{const o=yield ae(20);if(h(),o.success&&o.data.length>0){const e=o.data.map(p=>({name:`${new Date(p.created_at).toLocaleString("zh-CN")} (${p.backup_type==="auto"?"自动":"手动"})`,subname:`商品:${p.backup_data.stats.products_count} | 销售:${p.backup_data.stats.sales_count}`,id:p.id}));w({title:"选择要恢复的备份",message:"点击备份记录可恢复数据",showCancelButton:!0,confirmButtonText:"取消",className:"backup-list-dialog"}).catch(()=>{}),q(()=>S(this,null,function*(){const{showActionSheet:p}=yield import("./index-UkLcb2kz.js").then(B=>B.J);return{showActionSheet:p}}),__vite__mapDeps([0,1])).then(({showActionSheet:p})=>{p({actions:e,cancelText:"取消",description:"选择要恢复的云端备份",onSelect:B=>{R(B.id)}})})}else o.success&&o.data.length===0?f({message:"暂无云端备份记录",duration:2e3}):f({type:"fail",message:"获取备份列表失败："+o.error})}catch(o){h(),f({type:"fail",message:"获取备份列表失败："+o.message})}}),R=o=>S(this,null,function*(){w({title:"确认恢复",message:`恢复数据将覆盖当前所有数据，确定要继续吗？

建议先备份当前数据！`,showCancelButton:!0}).then(()=>S(this,null,function*(){C({message:"正在恢复数据...",forbidClick:!0,duration:0});try{const e=yield oe(o);h(),e.success?w({title:"恢复成功",message:e.message}).then(()=>{window.location.reload()}):f({type:"fail",message:"恢复失败："+e.error})}catch(e){h(),f({type:"fail",message:"恢复失败："+e.message})}})).catch(()=>{})});return(o,e)=>{const p=O("van-nav-bar"),B=O("van-notice-bar"),_=O("van-button"),N=O("van-icon");return x(),j("div",re,[v(p,{title:"数据管理","left-arrow":"",onClickLeft:e[0]||(e[0]=V=>A(a).back())}),s("div",ne,[s("div",ce,[e[7]||(e[7]=s("div",{class:"section-title"},"📊 数据统计",-1)),s("div",le,[s("div",ie,[e[2]||(e[2]=s("span",{class:"stat-label"},"商品数量",-1)),s("span",ue,I(n.value.productsCount)+" 个",1)]),s("div",de,[e[3]||(e[3]=s("span",{class:"stat-label"},"销售记录",-1)),s("span",pe,I(n.value.salesCount)+" 条",1)]),s("div",ge,[e[4]||(e[4]=s("span",{class:"stat-label"},"进货记录",-1)),s("span",me,I(n.value.purchasesCount)+" 条",1)]),s("div",fe,[e[5]||(e[5]=s("span",{class:"stat-label"},"最后备份",-1)),s("span",{class:K(["stat-value",{warning:d.value}])},I(n.value.lastBackupTime),3)])]),d.value?(x(),P(B,{key:0,"left-icon":"info-o",color:"#ff976a",background:"#fff7e6",style:{"margin-top":"12px"}},{default:b(()=>[...e[6]||(e[6]=[y(" 建议备份数据，距离上次备份已超过24小时 ",-1)])]),_:1})):M("",!0)]),s("div",ve,[e[11]||(e[11]=s("div",{class:"section-title"},"☁️ 云端备份",-1)),s("div",Se,[v(_,{type:"primary",size:"large",block:"",icon:"cloud-o",onClick:L,class:"action-button"},{default:b(()=>[...e[8]||(e[8]=[y(" 立即备份到云端 ",-1)])]),_:1}),v(_,{type:"default",size:"large",block:"",icon:"records",onClick:$,class:"action-button"},{default:b(()=>[...e[9]||(e[9]=[y(" 查看云端备份列表 ",-1)])]),_:1})]),s("div",he,[v(N,{name:"info-o"}),e[10]||(e[10]=s("span",null,"云端备份每天自动执行一次，数据更安全",-1))])]),s("div",ke,[e[16]||(e[16]=s("div",{class:"section-title"},"💾 本地备份",-1)),s("div",we,[v(_,{type:"primary",size:"large",block:"",icon:"down",onClick:i,class:"action-button"},{default:b(()=>[...e[12]||(e[12]=[y(" 导出完整备份（JSON） ",-1)])]),_:1}),v(_,{type:"success",size:"large",block:"",icon:"down",onClick:u,class:"action-button"},{default:b(()=>[...e[13]||(e[13]=[y(" 导出商品列表（CSV） ",-1)])]),_:1}),v(_,{type:"success",size:"large",block:"",icon:"down",onClick:m,class:"action-button"},{default:b(()=>[...e[14]||(e[14]=[y(" 导出销售记录（CSV） ",-1)])]),_:1})]),s("div",be,[v(N,{name:"info-o"}),e[15]||(e[15]=s("span",null,"本地备份可下载到设备，方便离线保存",-1))])]),s("div",ye,[e[19]||(e[19]=s("div",{class:"section-title"},"📥 数据恢复",-1)),s("div",_e,[s("input",{ref_key:"fileInput",ref:r,type:"file",accept:".json",style:{display:"none"},onChange:k},null,544),v(_,{type:"warning",size:"large",block:"",icon:"upgrade",onClick:e[1]||(e[1]=V=>o.$refs.fileInput.click()),class:"action-button"},{default:b(()=>[...e[17]||(e[17]=[y(" 从本地文件恢复数据 ",-1)])]),_:1})]),s("div",Ce,[v(N,{name:"warning-o"}),e[18]||(e[18]=s("span",null,"恢复数据将覆盖当前所有数据，请谨慎操作！",-1))])]),s("div",Be,[e[22]||(e[22]=s("div",{class:"section-title"},"🗑️ 数据清理",-1)),s("div",Ne,[v(_,{type:"danger",size:"large",block:"",icon:"delete-o",onClick:c,class:"action-button"},{default:b(()=>[...e[20]||(e[20]=[y(" 清空所有数据 ",-1)])]),_:1})]),s("div",Oe,[v(N,{name:"warning-o"}),e[21]||(e[21]=s("span",null,"此操作不可恢复，请务必先备份数据！",-1))])]),e[23]||(e[23]=z('<div class="card" data-v-14a4ee20><div class="section-title" data-v-14a4ee20>📖 使用说明</div><div class="help-content" data-v-14a4ee20><div class="help-item" data-v-14a4ee20><div class="help-title" data-v-14a4ee20>💾 完整备份（JSON）</div><div class="help-text" data-v-14a4ee20> 包含所有商品、销售和进货数据，可用于完整恢复系统数据。 </div></div><div class="help-item" data-v-14a4ee20><div class="help-title" data-v-14a4ee20>📊 导出CSV</div><div class="help-text" data-v-14a4ee20> 导出为Excel可打开的CSV格式，方便查看和打印。 </div></div><div class="help-item" data-v-14a4ee20><div class="help-title" data-v-14a4ee20>📥 数据恢复</div><div class="help-text" data-v-14a4ee20> 选择之前导出的JSON备份文件，可恢复所有数据。 </div></div><div class="help-item" data-v-14a4ee20><div class="help-title" data-v-14a4ee20>⚠️ 注意事项</div><div class="help-text" data-v-14a4ee20> • 建议每天备份一次数据<br data-v-14a4ee20> • 备份文件请妥善保管<br data-v-14a4ee20> • 恢复数据前请先备份当前数据<br data-v-14a4ee20> • 清空数据操作不可恢复 </div></div></div></div>',1))])])}}},Te=E(Ie,[["__scopeId","data-v-14a4ee20"]]);export{Te as default};
