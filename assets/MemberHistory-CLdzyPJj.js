var x=(R,S,u)=>new Promise((w,h)=>{var p=l=>{try{m(u.next(l))}catch(_){h(_)}},b=l=>{try{m(u.throw(l))}catch(_){h(_)}},m=l=>l.done?w(l.value):Promise.resolve(l.value).then(p,b);m((u=u.apply(R,S)).next())});import{_ as se,B as oe,j as ae,r as d,k,o as ne,c as v,d as n,b as s,w as g,e as y,l as E,a as le,t as r,n as D,F as L,p as j,f as z,C as ie,T as re,g as c,v as G}from"./index-B03wA3Sl.js";const de={class:"member-history-page page-container"},ue={class:"content-wrapper"},me={class:"stats-card card"},ve={class:"stats-grid"},ce={class:"stats-item"},pe={class:"stats-value success"},_e={class:"stats-item"},fe={class:"stats-value primary"},ye={class:"stats-item"},he={class:"stats-value"},be={class:"stats-item"},ge={class:"stats-value"},ke={class:"filter-tabs"},we={class:"history-list"},Ce={key:0,class:"empty-state"},Me={class:"history-header"},$e={class:"history-time"},De={class:"history-content"},Se={class:"history-member"},Te={class:"member-name"},Ve={class:"member-phone"},xe={key:0,class:"history-footer"},Re={key:0,class:"history-payment"},Fe={key:1,class:"history-notes"},Ie={class:"filter-popup"},Ae={class:"filter-header"},Be={class:"filter-content"},He={class:"filter-section"},Ne={class:"filter-section"},Pe={class:"filter-actions"},Ue={class:"picker-popup"},Ee={class:"picker-header"},Le={class:"picker-content"},je=["onClick"],ze={class:"member-picker-info"},Ge={class:"member-picker-name"},Ye={class:"member-picker-phone"},qe={__name:"MemberHistory",setup(R){const S=le(),u=oe(),w=ae(),h=d("all"),p=d(!1),b=d(!1),m=d(!1),l=d(null),_=d("å…¨éƒ¨ä¼šå‘˜"),f=d(null),C=d("å…¨éƒ¨æ—¥æœŸ"),F=d(new Date),I=d([]),A=d([]),B=d(!1),Y=()=>x(this,null,function*(){try{const{data:t,error:e}=yield ie.from(re.MEMBER_RECHARGES).select("*").order("created_at",{ascending:!1});if(e){console.error("åŠ è½½å……å€¼è®°å½•å¤±è´¥:",e);return}I.value=t.map(a=>{const i=u.getMemberById(a.member_id);return{id:a.id,type:"recharge",memberId:a.member_id,memberName:(i==null?void 0:i.name)||"æœªçŸ¥ä¼šå‘˜",memberPhone:(i==null?void 0:i.phone)||"",amount:parseFloat(a.amount)||0,paymentMethod:a.payment_method||"çŽ°é‡‘",notes:a.notes||"",time:new Date(a.created_at).getTime()}})}catch(t){console.error("åŠ è½½å……å€¼è®°å½•å¼‚å¸¸:",t)}}),q=()=>{A.value=w.getAllSales.filter(t=>t.memberId).map(t=>{const e=u.getMemberById(t.memberId);return{id:t.id,type:"consumption",memberId:t.memberId,memberName:(e==null?void 0:e.name)||"æœªçŸ¥ä¼šå‘˜",memberPhone:(e==null?void 0:e.phone)||"",amount:t.actualAmount||t.totalAmount,paymentMethod:t.paymentMethod||"ä¼šå‘˜ä½™é¢",notes:t.remark||"",time:t.time||t.date}})},M=k(()=>{let t=I.value;if(l.value&&(t=t.filter(e=>e.memberId===l.value.id)),f.value){const e=new Date(f.value).setHours(0,0,0,0),a=new Date(f.value).setHours(23,59,59,999);t=t.filter(i=>i.time>=e&&i.time<=a)}return t}),$=k(()=>{let t=A.value;if(l.value&&(t=t.filter(e=>e.memberId===l.value.id)),f.value){const e=new Date(f.value).setHours(0,0,0,0),a=new Date(f.value).setHours(23,59,59,999);t=t.filter(i=>i.time>=e&&i.time<=a)}return t}),H=k(()=>{let t=[];return h.value==="all"?t=[...M.value,...$.value]:h.value==="recharge"?t=M.value:t=$.value,t.sort((e,a)=>a.time-e.time)}),J=k(()=>M.value.reduce((t,e)=>t+e.amount,0)),K=k(()=>$.value.reduce((t,e)=>t+e.amount,0)),O=()=>{},N=t=>{l.value=t,_.value=t?`${t.name||"æœªå‘½å"} (${t.phone})`:"å…¨éƒ¨ä¼šå‘˜",b.value=!1},Q=t=>{f.value=t;const e=new Date(t);C.value=`${e.getFullYear()}å¹´${e.getMonth()+1}æœˆ${e.getDate()}æ—¥`,m.value=!1},W=()=>{l.value=null,_.value="å…¨éƒ¨ä¼šå‘˜",f.value=null,C.value="å…¨éƒ¨æ—¥æœŸ",p.value=!1},X=()=>{p.value=!1},Z=t=>{const e=new Date(t);return`${e.getMonth()+1}/${e.getDate()} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`};return ne(()=>x(this,null,function*(){B.value=!0,yield Promise.all([u.loadMembers(),w.loadSales(),Y()]),q(),B.value=!1})),(t,e)=>{const a=y("van-icon"),i=y("van-nav-bar"),T=y("van-tab"),ee=y("van-tabs"),P=y("van-field"),U=y("van-button"),V=y("van-popup"),te=y("van-datetime-picker");return c(),v("div",de,[n(i,{title:"ä¼šå‘˜åŽ†å²è®°å½•","left-arrow":"",onClickLeft:e[1]||(e[1]=o=>E(S).back())},{right:g(()=>[n(a,{name:"filter-o",onClick:e[0]||(e[0]=o=>p.value=!0)})]),_:1}),s("div",ue,[s("div",me,[s("div",ve,[s("div",ce,[e[15]||(e[15]=s("div",{class:"stats-label"},"æ€»å……å€¼",-1)),s("div",pe,"Â¥"+r(J.value.toFixed(2)),1)]),s("div",_e,[e[16]||(e[16]=s("div",{class:"stats-label"},"æ€»æ¶ˆè´¹",-1)),s("div",fe,"Â¥"+r(K.value.toFixed(2)),1)]),s("div",ye,[e[17]||(e[17]=s("div",{class:"stats-label"},"å……å€¼æ¬¡æ•°",-1)),s("div",he,r(M.value.length),1)]),s("div",be,[e[18]||(e[18]=s("div",{class:"stats-label"},"æ¶ˆè´¹æ¬¡æ•°",-1)),s("div",ge,r($.value.length),1)])])]),s("div",ke,[n(ee,{active:h.value,"onUpdate:active":e[2]||(e[2]=o=>h.value=o),onChange:O},{default:g(()=>[n(T,{title:"å…¨éƒ¨",name:"all"}),n(T,{title:"å……å€¼è®°å½•",name:"recharge"}),n(T,{title:"æ¶ˆè´¹è®°å½•",name:"consumption"})]),_:1},8,["active"])]),s("div",we,[H.value.length===0?(c(),v("div",Ce,[...e[19]||(e[19]=[s("div",{class:"empty-icon"},"ðŸ“‹",-1),s("div",{class:"empty-text"},"æš‚æ— è®°å½•",-1)])])):D("",!0),(c(!0),v(L,null,j(H.value,o=>(c(),v("div",{key:o.id,class:"history-item"},[s("div",Me,[s("span",{class:G(["history-type",o.type])},r(o.type==="recharge"?"å……å€¼":"æ¶ˆè´¹"),3),s("span",$e,r(Z(o.time)),1)]),s("div",De,[s("div",Se,[s("div",Te,r(o.memberName),1),s("div",Ve,r(o.memberPhone),1)]),s("div",{class:G(["history-amount",o.type])},r(o.type==="recharge"?"+":"-")+"Â¥"+r(o.amount.toFixed(2)),3)]),o.notes||o.paymentMethod?(c(),v("div",xe,[o.paymentMethod?(c(),v("span",Re,r(o.paymentMethod),1)):D("",!0),o.notes?(c(),v("span",Fe,r(o.notes),1)):D("",!0)])):D("",!0)]))),128))])]),n(V,{show:p.value,"onUpdate:show":e[8]||(e[8]=o=>p.value=o),position:"bottom",style:{height:"60%"}},{default:g(()=>[s("div",Ie,[s("div",Ae,[e[20]||(e[20]=s("span",{class:"filter-title"},"ç­›é€‰æ¡ä»¶",-1)),n(a,{name:"cross",onClick:e[3]||(e[3]=o=>p.value=!1)})]),s("div",Be,[s("div",He,[e[21]||(e[21]=s("div",{class:"filter-section-title"},"é€‰æ‹©ä¼šå‘˜",-1)),n(P,{modelValue:_.value,"onUpdate:modelValue":e[4]||(e[4]=o=>_.value=o),placeholder:"å…¨éƒ¨ä¼šå‘˜",readonly:"","is-link":"",onClick:e[5]||(e[5]=o=>b.value=!0)},null,8,["modelValue"])]),s("div",Ne,[e[22]||(e[22]=s("div",{class:"filter-section-title"},"æ—¥æœŸèŒƒå›´",-1)),n(P,{modelValue:C.value,"onUpdate:modelValue":e[6]||(e[6]=o=>C.value=o),placeholder:"å…¨éƒ¨æ—¥æœŸ",readonly:"","is-link":"",onClick:e[7]||(e[7]=o=>m.value=!0)},null,8,["modelValue"])]),s("div",Pe,[n(U,{block:"",onClick:W},{default:g(()=>[...e[23]||(e[23]=[z("é‡ç½®",-1)])]),_:1}),n(U,{type:"primary",block:"",onClick:X},{default:g(()=>[...e[24]||(e[24]=[z("ç¡®å®š",-1)])]),_:1})])])])]),_:1},8,["show"]),n(V,{show:b.value,"onUpdate:show":e[11]||(e[11]=o=>b.value=o),position:"bottom",style:{height:"50%"}},{default:g(()=>[s("div",Ue,[s("div",Ee,[e[25]||(e[25]=s("span",{class:"picker-title"},"é€‰æ‹©ä¼šå‘˜",-1)),n(a,{name:"cross",onClick:e[9]||(e[9]=o=>b.value=!1)})]),s("div",Le,[s("div",{class:"member-picker-item",onClick:e[10]||(e[10]=o=>N(null))},[...e[26]||(e[26]=[s("div",{class:"member-picker-name"},"å…¨éƒ¨ä¼šå‘˜",-1)])]),(c(!0),v(L,null,j(E(u).getAllMembers,o=>(c(),v("div",{key:o.id,class:"member-picker-item",onClick:Je=>N(o)},[s("div",ze,[s("div",Ge,r(o.name||"æœªå‘½å"),1),s("div",Ye,r(o.phone),1)])],8,je))),128))])])]),_:1},8,["show"]),n(V,{show:m.value,"onUpdate:show":e[14]||(e[14]=o=>m.value=o),position:"bottom",round:"",closeable:"","close-icon":"close",style:{paddingTop:"46px"}},{default:g(()=>[n(te,{modelValue:F.value,"onUpdate:modelValue":e[12]||(e[12]=o=>F.value=o),type:"date",title:"é€‰æ‹©æ—¥æœŸ",onConfirm:Q,onCancel:e[13]||(e[13]=o=>m.value=!1)},null,8,["modelValue"])]),_:1},8,["show"])])}}},Qe=se(qe,[["__scopeId","data-v-5ec456ab"]]);export{Qe as default};
