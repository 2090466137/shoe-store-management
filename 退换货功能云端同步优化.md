# é€€æ¢è´§åŠŸèƒ½äº‘ç«¯åŒæ­¥ä¼˜åŒ–

## ğŸš¨ å‘ç°çš„é—®é¢˜

### 1. **æ²¡æœ‰äº‘ç«¯åŒæ­¥æœºåˆ¶**
- é€€æ¢è´§æ•°æ®åªä¿å­˜åœ¨ `localStorage`
- æ²¡æœ‰ Supabase è¡¨ç”¨äºå­˜å‚¨é€€æ¢è´§è®°å½•
- åˆ·æ–°é¡µé¢æˆ–åˆ‡æ¢è®¾å¤‡ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### 2. **æ²¡æœ‰æ™ºèƒ½æ•°æ®åˆå¹¶**
- `loadReturns()` åªä» localStorage åŠ è½½
- æ²¡æœ‰åƒ `product.js`ã€`sales.js` é‚£æ ·çš„æ™ºèƒ½åˆå¹¶ç­–ç•¥
- å¤šè®¾å¤‡ä½¿ç”¨ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±

### 3. **äº‘ç«¯å¤‡ä»½ä¸å®Œæ•´**
- `cloudBackup.js` çš„å¤‡ä»½ä¸åŒ…å«é€€æ¢è´§è®°å½•
- åªå¤‡ä»½äº†ï¼šproductsã€salesã€purchasesã€members

### 4. **æ•°æ®åº“è¡¨ç¼ºå¤±**
- `TABLES` å¸¸é‡ä¸­æ²¡æœ‰å®šä¹‰ `RETURNS` è¡¨

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ æ•°æ®åº“è¡¨å®šä¹‰

**æ–‡ä»¶ï¼š`src/config/supabase.js`**

```javascript
export const TABLES = {
  PRODUCTS: 'products',
  SALES: 'sales',
  PURCHASES: 'purchases',
  MEMBERS: 'members',
  MEMBER_RECHARGES: 'member_recharges',
  USERS: 'users',
  BACKUPS: 'backups',
  RETURNS: 'returns'  // âœ… æ–°å¢ï¼šé€€æ¢è´§è®°å½•è¡¨
}
```

### 2. åˆ›å»ºä¸“é—¨çš„ Returns Store

**æ–°æ–‡ä»¶ï¼š`src/stores/returns.js`**

#### æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **æ•°æ®æ ¼å¼è½¬æ¢**
   - `frontendToDb()` - å‰ç«¯æ ¼å¼è½¬æ•°æ®åº“æ ¼å¼
   - `dbToFrontend()` - æ•°æ®åº“æ ¼å¼è½¬å‰ç«¯æ ¼å¼

2. **æ™ºèƒ½æ•°æ®åŠ è½½**
   ```javascript
   const loadReturns = async () => {
     // 1. å…ˆä» localStorage åŠ è½½ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
     // 2. ä»äº‘ç«¯åŠ è½½æ•°æ®
     // 3. æ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
     // 4. ä¿å­˜åˆ° localStorage
   }
   ```

3. **æ™ºèƒ½åˆå¹¶ç­–ç•¥**
   ```javascript
   const smartMergeReturns = (localReturns, cloudReturns) => {
     // äº‘ç«¯æ•°æ® + æœ¬åœ°æ–°å¢æ•°æ®
     // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä½¿ç”¨è¾ƒæ–°çš„ç‰ˆæœ¬
   }
   ```

4. **äº‘ç«¯åŒæ­¥çš„æ·»åŠ **
   ```javascript
   const addReturn = async (returnRecord) => {
     try {
       // 1. å°è¯•ä¿å­˜åˆ°äº‘ç«¯
       // 2. æ›´æ–°åº“å­˜
       // 3. ä¿å­˜åˆ° localStorage
     } catch {
       // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
     }
   }
   ```

5. **äº‘ç«¯åŒæ­¥çš„åˆ é™¤ï¼ˆæ’¤é”€ï¼‰**
   ```javascript
   const deleteReturn = async (returnId) => {
     // 1. åˆ¤æ–­æ˜¯æœ¬åœ°è®°å½•è¿˜æ˜¯äº‘ç«¯è®°å½•
     // 2. ä»äº‘ç«¯åˆ é™¤ï¼ˆå¦‚æœæ˜¯äº‘ç«¯è®°å½•ï¼‰
     // 3. ä»æœ¬åœ°åˆ é™¤
     // 4. æ¢å¤åº“å­˜
   }
   ```

### 3. æ›´æ–° Returns.vue ä½¿ç”¨æ–° Store

**ä¸»è¦å˜æ›´ï¼š**

```javascript
// âŒ æ—§æ–¹å¼ï¼šç›´æ¥æ“ä½œ localStorage
const returns = ref([])
const loadReturns = () => {
  const stored = localStorage.getItem('returns')
  if (stored) {
    returns.value = JSON.parse(stored)
  }
}

// âœ… æ–°æ–¹å¼ï¼šä½¿ç”¨ store
import { useReturnsStore } from '@/stores/returns'
const returnsStore = useReturnsStore()

// ä» store è·å–æ•°æ®
const filteredReturns = computed(() => returnsStore.getAllReturns)

// ä½¿ç”¨ store æ–¹æ³•
await returnsStore.addReturn(returnRecord)
await returnsStore.deleteReturn(item.id)
await returnsStore.loadReturns()
```

### 4. æ›´æ–°äº‘ç«¯å¤‡ä»½

**æ–‡ä»¶ï¼š`src/utils/cloudBackup.js`**

```javascript
// âœ… æ·»åŠ é€€æ¢è´§æ•°æ®åˆ°å¤‡ä»½
const returns = localStorage.getItem('returns')

const backupData = {
  data: {
    products: products ? JSON.parse(products) : [],
    sales: sales ? JSON.parse(sales) : [],
    purchases: purchases ? JSON.parse(purchases) : [],
    members: members ? JSON.parse(members) : [],
    returns: returns ? JSON.parse(returns) : []  // âœ… æ–°å¢
  },
  stats: {
    products_count: products ? JSON.parse(products).length : 0,
    sales_count: sales ? JSON.parse(sales).length : 0,
    purchases_count: purchases ? JSON.parse(purchases).length : 0,
    members_count: members ? JSON.parse(members).length : 0,
    returns_count: returns ? JSON.parse(returns).length : 0  // âœ… æ–°å¢
  }
}
```

---

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

éœ€è¦åœ¨ Supabase ä¸­åˆ›å»º `returns` è¡¨ï¼š

```sql
CREATE TABLE returns (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL,  -- 'return' æˆ– 'exchange'
  time TIMESTAMPTZ NOT NULL,
  original_sale_id TEXT NOT NULL,
  original_product JSONB NOT NULL,
  new_product JSONB,
  reason TEXT,
  amount NUMERIC NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_returns_time ON returns(time DESC);
CREATE INDEX idx_returns_type ON returns(type);
CREATE INDEX idx_returns_sale_id ON returns(original_sale_id);
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### æ·»åŠ é€€æ¢è´§è®°å½•

```
ç”¨æˆ·æäº¤é€€æ¢è´§
    â†“
returnsStore.addReturn()
    â†“
å°è¯•ä¿å­˜åˆ° Supabase
    â†“
æˆåŠŸ â†’ ä½¿ç”¨äº‘ç«¯è¿”å›çš„æ•°æ®
å¤±è´¥ â†’ é™çº§åˆ°æœ¬åœ°å­˜å‚¨
    â†“
æ›´æ–°åº“å­˜
    â†“
ä¿å­˜åˆ° localStorage
```

### åŠ è½½é€€æ¢è´§è®°å½•

```
é¡µé¢åŠ è½½
    â†“
returnsStore.loadReturns()
    â†“
1. ä» localStorage åŠ è½½ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
    â†“
2. ä» Supabase åŠ è½½
    â†“
3. æ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
   - äº‘ç«¯æœ‰ï¼Œæœ¬åœ°æ²¡æœ‰ â†’ æ·»åŠ 
   - æœ¬åœ°æœ‰ï¼Œäº‘ç«¯æ²¡æœ‰ â†’ ä¿ç•™ï¼ˆå¾…åŒæ­¥ï¼‰
   - éƒ½æœ‰ â†’ æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œä½¿ç”¨è¾ƒæ–°çš„
    â†“
4. æ›´æ–° localStorage
```

### æ’¤é”€é€€æ¢è´§è®°å½•

```
ç”¨æˆ·ç‚¹å‡»æ’¤é”€
    â†“
returnsStore.deleteReturn()
    â†“
åˆ¤æ–­è®°å½•ç±»å‹
    â†“
äº‘ç«¯è®°å½• â†’ ä» Supabase åˆ é™¤
æœ¬åœ°è®°å½• â†’ è·³è¿‡äº‘ç«¯åˆ é™¤
    â†“
ä»æœ¬åœ°åˆ é™¤
    â†“
æ¢å¤åº“å­˜å˜åŒ–
    â†“
æ›´æ–° localStorage
```

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### âœ… æ•°æ®å®‰å…¨æ€§
- é€€æ¢è´§è®°å½•è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
- æœ¬åœ°å’Œäº‘ç«¯åŒé‡ä¿éšœ
- åˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±æ•°æ®

### âœ… å¤šè®¾å¤‡åŒæ­¥
- ä¸åŒè®¾å¤‡çš„æ•°æ®è‡ªåŠ¨åˆå¹¶
- æ™ºèƒ½å†²çªè§£å†³ï¼ˆæ—¶é—´æˆ³ä¼˜å…ˆï¼‰
- ç¦»çº¿æ“ä½œåè‡ªåŠ¨åŒæ­¥

### âœ… æ•°æ®ä¸€è‡´æ€§
- ä¸ productsã€salesã€members ä½¿ç”¨ç›¸åŒçš„åŒæ­¥ç­–ç•¥
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé™çº§æœºåˆ¶
- å®Œæ•´çš„äº‘ç«¯å¤‡ä»½

### âœ… ç”¨æˆ·ä½“éªŒ
- æ“ä½œç«‹å³å“åº”ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼‰
- åå°è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯
- å¤±è´¥æ—¶è‡ªåŠ¨é™çº§ï¼Œä¸å½±å“ä½¿ç”¨

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/config/supabase.js` - æ·»åŠ  RETURNS è¡¨å®šä¹‰
2. âœ… `src/stores/returns.js` - æ–°å»ºé€€æ¢è´§ store
3. âœ… `src/views/Returns.vue` - ä½¿ç”¨æ–°çš„ store
4. âœ… `src/utils/cloudBackup.js` - æ·»åŠ é€€æ¢è´§å¤‡ä»½

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. åœ¨ Supabase ä¸­åˆ›å»ºè¡¨

ç™»å½• Supabase â†’ SQL Editor â†’ æ‰§è¡Œä¸Šé¢çš„ SQL è¯­å¥

### 2. æäº¤ä»£ç åˆ° GitHub

```bash
git add .
git commit -m "feat: é€€æ¢è´§åŠŸèƒ½äº‘ç«¯åŒæ­¥ä¼˜åŒ–"
git push origin main
```

### 3. éªŒè¯åŠŸèƒ½

- æ·»åŠ é€€æ¢è´§è®°å½• â†’ æ£€æŸ¥ Supabase è¡¨
- åˆ·æ–°é¡µé¢ â†’ æ•°æ®ä¸ä¸¢å¤±
- åˆ‡æ¢è®¾å¤‡ â†’ æ•°æ®è‡ªåŠ¨åŒæ­¥
- æ’¤é”€è®°å½• â†’ äº‘ç«¯å’Œæœ¬åœ°éƒ½åˆ é™¤

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¡¨å¿…é¡»å…ˆåˆ›å»º**
   - åœ¨éƒ¨ç½²å‰ç¡®ä¿ Supabase ä¸­å·²åˆ›å»º `returns` è¡¨
   - å¦åˆ™ä¼šé™çº§åˆ°çº¯æœ¬åœ°æ¨¡å¼

2. **æ—§æ•°æ®è¿ç§»**
   - ç°æœ‰çš„æœ¬åœ°é€€æ¢è´§æ•°æ®ä¼šåœ¨é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨ä¸Šä¼ åˆ°äº‘ç«¯
   - å»ºè®®åœ¨ä½å³°æœŸè¿›è¡Œéƒ¨ç½²

3. **æƒé™é…ç½®**
   - ç¡®ä¿ Supabase RLS ç­–ç•¥å…è®¸è¯»å†™ `returns` è¡¨
   - å»ºè®®é…ç½®ä¸ `sales` è¡¨ç›¸åŒçš„æƒé™

---

## ğŸ“Š å¯¹æ¯”å…¶ä»–åŠŸèƒ½

| åŠŸèƒ½ | äº‘ç«¯åŒæ­¥ | æ™ºèƒ½åˆå¹¶ | äº‘ç«¯å¤‡ä»½ | é™çº§æœºåˆ¶ |
|------|---------|---------|---------|---------|
| å•†å“ç®¡ç† | âœ… | âœ… | âœ… | âœ… |
| é”€å”®è®°å½• | âœ… | âœ… | âœ… | âœ… |
| ä¼šå‘˜ç®¡ç† | âœ… | âœ… | âœ… | âœ… |
| **é€€æ¢è´§** | âœ… **æ–°å¢** | âœ… **æ–°å¢** | âœ… **æ–°å¢** | âœ… **æ–°å¢** |

ç°åœ¨é€€æ¢è´§åŠŸèƒ½å·²ç»ä¸å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ä¿æŒä¸€è‡´çš„æ•°æ®ç®¡ç†ç­–ç•¥ï¼

