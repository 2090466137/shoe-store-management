# 功能优化计划

## 📊 当前状态评估

### ✅ 已完成的功能

1. **基础功能**
   - ✅ 商品管理（增删改查）
   - ✅ 销售管理（多商品购物车）
   - ✅ 进货管理
   - ✅ 会员管理（充值、消费）
   - ✅ 退换货管理
   - ✅ 用户权限控制

2. **数据同步**
   - ✅ 云端数据库（Supabase）
   - ✅ 本地缓存（localStorage）
   - ✅ 智能数据合并
   - ✅ 离线降级支持

3. **数据可视化**
   - ✅ 销售趋势图
   - ✅ 基础统计数据

4. **安全性**
   - ✅ 权限控制完善
   - ✅ 密码加密存储（SHA-256）✨ **刚刚修复**

---

## 🎯 待优化功能清单

### 优先级 P0（紧急）

#### ✅ 1. 密码加密存储
**状态**：✅ **已完成**
- 使用 SHA-256 加密
- 自动迁移明文密码
- 登录验证加密比对

---

### 优先级 P1（重要）

#### ❌ 2. 操作日志记录
**目标**：记录所有关键操作，便于审计和问题追踪

**功能需求**：
- 记录用户登录/登出
- 记录商品增删改
- 记录销售/退换货操作
- 记录会员充值/消费
- 记录数据删除操作

**数据结构**：
```javascript
{
  id: 'log_xxx',
  userId: 'user_id',
  userName: '操作人姓名',
  action: 'delete_sale',  // 操作类型
  target: 'sale_xxx',     // 目标对象ID
  targetName: '销售记录', // 目标对象名称
  details: {              // 详细信息
    before: {},           // 操作前数据
    after: {}             // 操作后数据
  },
  timestamp: 1234567890,
  ip: '192.168.1.1'       // 可选
}
```

**实现方案**：
1. 创建 `src/stores/auditLog.js`
2. 创建 `src/views/AuditLog.vue`（仅店长可见）
3. 在关键操作处添加日志记录
4. 支持按时间、用户、操作类型筛选

---

#### ❌ 3. 数据修改审计
**目标**：追踪数据变更历史

**功能需求**：
- 商品价格变更历史
- 库存变更历史
- 会员余额变更历史
- 支持查看变更详情

**实现方案**：
1. 在修改数据时记录变更前后的值
2. 创建变更历史查看页面
3. 支持按商品/会员查看历史

---

### 优先级 P2（建议）

#### ❌ 4. 库存分析图表
**目标**：可视化库存状况

**功能需求**：
- 库存预警（低库存商品）
- 库存周转率分析
- 滞销商品识别
- 库存金额统计

**图表类型**：
- 柱状图：各品牌库存对比
- 饼图：库存金额占比
- 折线图：库存变化趋势
- 表格：低库存商品列表

**实现方案**：
1. 创建 `src/views/InventoryAnalysis.vue`
2. 使用 ECharts 或 Chart.js
3. 添加库存预警阈值设置

---

#### ❌ 5. 利润分析图表
**目标**：分析销售利润情况

**功能需求**：
- 每日/每周/每月利润统计
- 商品利润率排行
- 品牌利润对比
- 利润趋势分析

**图表类型**：
- 折线图：利润趋势
- 柱状图：商品利润排行
- 饼图：品牌利润占比
- 仪表盘：利润率指标

**计算公式**：
```
单品利润 = (销售价 - 成本价) × 销售数量
利润率 = (销售价 - 成本价) / 销售价 × 100%
```

**实现方案**：
1. 创建 `src/views/ProfitAnalysis.vue`
2. 添加时间范围筛选
3. 支持导出报表

---

#### ❌ 6. 商品分类占比图
**目标**：分析商品销售结构

**功能需求**：
- 按品牌统计销售占比
- 按尺码统计销售占比
- 按价格区间统计
- 热销商品 TOP 10

**图表类型**：
- 饼图：品牌销售占比
- 环形图：尺码分布
- 柱状图：价格区间销售量
- 排行榜：热销商品

**实现方案**：
1. 创建 `src/views/ProductAnalysis.vue`
2. 添加多维度分析
3. 支持自定义时间范围

---

## 📋 实施计划

### 第一阶段（已完成）✅
- ✅ 密码加密存储
- ✅ 退换货功能云端同步
- ✅ 严重问题修复

### 第二阶段（建议优先）
**预计时间**：3-5天

1. **操作日志系统**（2天）
   - Day 1: 创建日志 store 和数据库表
   - Day 2: 集成到各个功能模块，创建查看页面

2. **数据修改审计**（1天）
   - 在关键数据修改处添加审计记录
   - 创建审计查看页面

3. **库存分析图表**（2天）
   - Day 1: 数据统计和计算
   - Day 2: 图表展示和交互

### 第三阶段（增强功能）
**预计时间**：3-4天

1. **利润分析图表**（2天）
   - 利润计算逻辑
   - 多维度图表展示

2. **商品分类占比图**（1-2天）
   - 多维度统计
   - 可视化展示

---

## 🛠️ 技术选型

### 图表库
推荐：**ECharts**
- ✅ 功能强大，图表类型丰富
- ✅ 中文文档完善
- ✅ 移动端适配好
- ✅ 支持主题定制

安装：
```bash
npm install echarts
```

### 日志存储
**方案1：Supabase 表**
- 优点：云端存储，多设备同步
- 缺点：需要创建新表

**方案2：localStorage + 定期上传**
- 优点：实现简单，离线可用
- 缺点：存储空间有限

**推荐**：方案1（Supabase）

---

## 📊 数据库表设计

### 操作日志表（audit_logs）
```sql
CREATE TABLE audit_logs (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  user_name TEXT NOT NULL,
  action TEXT NOT NULL,
  target_type TEXT NOT NULL,  -- 'product', 'sale', 'member', etc.
  target_id TEXT,
  target_name TEXT,
  details JSONB,
  timestamp TIMESTAMPTZ NOT NULL,
  ip_address TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_timestamp ON audit_logs(timestamp DESC);
CREATE INDEX idx_audit_logs_target ON audit_logs(target_type, target_id);
```

### 数据变更历史表（change_history）
```sql
CREATE TABLE change_history (
  id TEXT PRIMARY KEY,
  entity_type TEXT NOT NULL,  -- 'product', 'member', etc.
  entity_id TEXT NOT NULL,
  field_name TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_by TEXT NOT NULL,
  changed_at TIMESTAMPTZ NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_change_history_entity ON change_history(entity_type, entity_id);
CREATE INDEX idx_change_history_time ON change_history(changed_at DESC);
```

---

## 🎯 下一步建议

### 立即执行
1. ✅ 提交当前的严重问题修复
2. ✅ 部署并测试修复效果

### 短期计划（1-2周）
1. 实现操作日志系统
2. 添加库存分析图表
3. 完善数据审计功能

### 中期计划（1个月）
1. 实现利润分析系统
2. 添加商品分类分析
3. 优化数据可视化

---

## 📞 需要确认的问题

1. **优先级确认**：您希望优先实现哪些功能？
   - [ ] 操作日志记录
   - [ ] 库存分析图表
   - [ ] 利润分析图表
   - [ ] 商品分类占比

2. **图表库选择**：是否同意使用 ECharts？
   - [ ] 同意
   - [ ] 使用其他库（请指定）

3. **实施时间**：是否现在开始实施？
   - [ ] 是，立即开始
   - [ ] 否，先部署当前修复

---

**文档创建时间**：2025-01-01
**版本**：v1.0
**状态**：待确认

