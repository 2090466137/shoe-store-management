# ä¸¥é‡é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ğŸš¨ å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼šåˆ é™¤é”€å”®è®°å½•ååº“å­˜æœªæ¢å¤ âš ï¸ ä¸¥é‡
**å½±å“**ï¼šä¼šå¯¼è‡´åº“å­˜æ•°æ®é”™è¯¯ï¼Œå½±å“è´¢åŠ¡ç»Ÿè®¡
**ä½ç½®**ï¼š`src/stores/sales.js` ç¬¬318è¡Œ

**é—®é¢˜æè¿°**ï¼š
- åˆ é™¤é”€å”®è®°å½•æ—¶ï¼Œåªåˆ é™¤äº†è®°å½•æœ¬èº«
- æ²¡æœ‰æ¢å¤å¯¹åº”å•†å“çš„åº“å­˜
- å¯¼è‡´åº“å­˜æ•°æ®ä¸å®é™…ä¸ç¬¦

---

### é—®é¢˜2ï¼šå¯†ç æ˜æ–‡å­˜å‚¨ âš ï¸ ä¸¥é‡
**å½±å“**ï¼šå®‰å…¨éšæ‚£ï¼Œç”¨æˆ·å¯†ç å¯è¢«ç›´æ¥è¯»å–
**ä½ç½®**ï¼š`src/stores/user.js` ç¬¬109è¡Œ

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·å¯†ç ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨åœ¨æ•°æ®åº“å’Œ localStorage
- ç™»å½•éªŒè¯ç›´æ¥æ¯”è¾ƒæ˜æ–‡å¯†ç 
- å­˜åœ¨ä¸¥é‡çš„å®‰å…¨é£é™©

---

### é—®é¢˜3ï¼šè¿›è´§æˆæœ¬ä»·ç›´æ¥è¦†ç›– âš ï¸ ä¸­ç­‰
**å½±å“**ï¼šè´¢åŠ¡æ•°æ®ä¸å‡†ç¡®ï¼Œæˆæœ¬æ ¸ç®—é”™è¯¯
**ä½ç½®**ï¼š`src/stores/sales.js` ç¬¬389è¡Œ

**é—®é¢˜æè¿°**ï¼š
- æ¯æ¬¡è¿›è´§ç›´æ¥ç”¨æ–°æˆæœ¬ä»·è¦†ç›–æ—§æˆæœ¬ä»·
- æ²¡æœ‰è€ƒè™‘åº“å­˜ä¸­ä¸åŒæ‰¹æ¬¡çš„å•†å“
- å¯¼è‡´æˆæœ¬ä»·è®¡ç®—ä¸å‡†ç¡®

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šåˆ é™¤é”€å”®è®°å½•æ—¶æ¢å¤åº“å­˜

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/stores/sales.js`

**ä¿®å¤å†…å®¹**ï¼š
```javascript
const deleteSale = async (id) => {
  const productStore = useProductStore()
  const tempSale = sales.value[index]
  
  try {
    // 1. æ¢å¤åº“å­˜ï¼ˆé”€å”®è®°å½•åˆ é™¤ = åº“å­˜å¢åŠ ï¼‰
    if (tempSale.products && Array.isArray(tempSale.products)) {
      // å¤šå•†å“æ¨¡å¼
      for (const item of tempSale.products) {
        await productStore.updateStock(item.productId, item.quantity, 'add')
      }
    } else if (tempSale.productId) {
      // å•å•†å“æ¨¡å¼ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
      await productStore.updateStock(tempSale.productId, tempSale.quantity, 'add')
    }
    
    // 2. åˆ é™¤è®°å½•
    // 3. å¦‚æœäº‘ç«¯åˆ é™¤å¤±è´¥ï¼Œå›æ»šåº“å­˜
  }
}
```

**æ•ˆæœ**ï¼š
- âœ… åˆ é™¤é”€å”®è®°å½•æ—¶è‡ªåŠ¨æ¢å¤åº“å­˜
- âœ… æ”¯æŒå¤šå•†å“å’Œå•å•†å“æ¨¡å¼
- âœ… äº‘ç«¯åˆ é™¤å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

### ä¿®å¤2ï¼šå®ç°å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆSHA-256ï¼‰

**æ–°å¢æ–‡ä»¶**ï¼š`src/utils/crypto.js`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```javascript
// 1. å¯†ç å“ˆå¸ŒåŠ å¯†
export async function hashPassword(password) {
  const encoder = new TextEncoder()
  const data = encoder.encode(password)
  const hashBuffer = await crypto.subtle.digest('SHA-256', data)
  const hashArray = Array.from(new Uint8Array(hashBuffer))
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
  return hashHex
}

// 2. å¯†ç éªŒè¯
export async function verifyPassword(password, hashedPassword) {
  const hash = await hashPassword(password)
  return hash === hashedPassword
}

// 3. è‡ªåŠ¨è¿ç§»æ˜æ–‡å¯†ç 
export async function migratePassword(password) {
  if (isPasswordHashed(password)) {
    return password  // å·²åŠ å¯†
  }
  return await hashPassword(password)  // åŠ å¯†æ˜æ–‡å¯†ç 
}
```

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/stores/user.js`

**ä¿®å¤å†…å®¹**ï¼š
1. **ç™»å½•éªŒè¯**ï¼š
```javascript
const login = async (username, password) => {
  const user = users.value.find(u => u.username === username)
  if (!user) return { success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' }
  
  // ä½¿ç”¨åŠ å¯†éªŒè¯
  const isPasswordValid = await verifyPassword(password, user.password)
  if (!isPasswordValid) return { success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' }
  
  // ...
}
```

2. **æ·»åŠ ç”¨æˆ·**ï¼š
```javascript
const addUser = async (userData) => {
  // åŠ å¯†å¯†ç 
  const hashedPassword = await hashPassword(userData.password || '123456')
  
  const newUser = {
    // ...
    password: hashedPassword,  // å­˜å‚¨åŠ å¯†å¯†ç 
    // ...
  }
}
```

3. **é‡ç½®å¯†ç **ï¼š
```javascript
const resetPassword = async (id, newPassword = '123456') => {
  // åŠ å¯†æ–°å¯†ç 
  const hashedPassword = await hashPassword(newPassword)
  users.value[index].password = hashedPassword
}
```

4. **è‡ªåŠ¨è¿ç§»**ï¼š
```javascript
const loadUsers = async () => {
  // åŠ è½½ç”¨æˆ·æ—¶è‡ªåŠ¨è¿ç§»æ˜æ–‡å¯†ç 
  users.value = await Promise.all(data.map(async (u) => ({
    ...u,
    password: await migratePassword(u.password)  // è‡ªåŠ¨åŠ å¯†
  })))
}
```

**æ•ˆæœ**ï¼š
- âœ… æ‰€æœ‰å¯†ç ä½¿ç”¨ SHA-256 åŠ å¯†å­˜å‚¨
- âœ… ç™»å½•éªŒè¯ä½¿ç”¨åŠ å¯†æ¯”å¯¹
- âœ… è‡ªåŠ¨è¿ç§»ç°æœ‰æ˜æ–‡å¯†ç 
- âœ… æ–°å¢å’Œé‡ç½®å¯†ç è‡ªåŠ¨åŠ å¯†
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·

---

### ä¿®å¤3ï¼šä½¿ç”¨åŠ æƒå¹³å‡æ³•æ›´æ–°æˆæœ¬ä»·

**ä¿®æ”¹æ–‡ä»¶**ï¼š`src/stores/sales.js`

**ä¿®å¤å†…å®¹**ï¼š
```javascript
const addPurchase = async (purchase) => {
  // æ›´æ–°åº“å­˜
  await productStore.updateStock(purchase.productId, purchase.quantity, 'add')
  
  // ä½¿ç”¨åŠ æƒå¹³å‡æ³•æ›´æ–°æˆæœ¬ä»·
  const currentProduct = productStore.getProductById(purchase.productId)
  if (currentProduct) {
    const oldStock = currentProduct.stock - purchase.quantity  // è¿›è´§å‰çš„åº“å­˜
    const oldCost = currentProduct.costPrice
    const newCost = purchase.costPrice
    const newQuantity = purchase.quantity
    
    // åŠ æƒå¹³å‡æˆæœ¬ä»· = (åŸåº“å­˜ Ã— åŸæˆæœ¬ä»· + æ–°è¿›è´§é‡ Ã— æ–°æˆæœ¬ä»·) / (åŸåº“å­˜ + æ–°è¿›è´§é‡)
    let weightedAvgCost
    if (oldStock <= 0) {
      // å¦‚æœåŸåº“å­˜ä¸º0æˆ–è´Ÿæ•°ï¼Œç›´æ¥ä½¿ç”¨æ–°æˆæœ¬ä»·
      weightedAvgCost = newCost
    } else {
      weightedAvgCost = (oldStock * oldCost + newQuantity * newCost) / (oldStock + newQuantity)
    }
    
    await productStore.updateProduct(purchase.productId, { 
      costPrice: Math.round(weightedAvgCost * 100) / 100  // ä¿ç•™ä¸¤ä½å°æ•°
    })
    
    console.log(`âœ… æˆæœ¬ä»·æ›´æ–°: ${oldCost} â†’ ${Math.round(weightedAvgCost * 100) / 100} (åŠ æƒå¹³å‡)`)
  }
}
```

**è®¡ç®—ç¤ºä¾‹**ï¼š
```
åŸåº“å­˜ï¼š100åŒï¼Œæˆæœ¬ä»·ï¼š50å…ƒ
æ–°è¿›è´§ï¼š50åŒï¼Œæˆæœ¬ä»·ï¼š60å…ƒ

åŠ æƒå¹³å‡æˆæœ¬ä»· = (100 Ã— 50 + 50 Ã— 60) / (100 + 50)
                = (5000 + 3000) / 150
                = 8000 / 150
                = 53.33å…ƒ
```

**æ•ˆæœ**ï¼š
- âœ… æˆæœ¬ä»·è®¡ç®—æ›´å‡†ç¡®
- âœ… è€ƒè™‘ä¸åŒæ‰¹æ¬¡çš„å•†å“
- âœ… ç¬¦åˆä¼šè®¡å‡†åˆ™ï¼ˆåŠ æƒå¹³å‡æ³•ï¼‰
- âœ… è‡ªåŠ¨å¤„ç†åº“å­˜ä¸º0çš„æƒ…å†µ
- âœ… ä¿ç•™ä¸¤ä½å°æ•°ï¼Œé¿å…ç²¾åº¦é—®é¢˜

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `src/stores/sales.js` - ä¿®å¤åˆ é™¤é”€å”®è®°å½•å’Œè¿›è´§æˆæœ¬ä»·é€»è¾‘
2. âœ… `src/stores/user.js` - å®ç°å¯†ç åŠ å¯†
3. âœ… `src/utils/crypto.js` - **æ–°å»º**å¯†ç åŠ å¯†å·¥å…·

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### æµ‹è¯•1ï¼šåˆ é™¤é”€å”®è®°å½•
1. æ·»åŠ ä¸€æ¡é”€å”®è®°å½•ï¼ˆåº“å­˜å‡å°‘ï¼‰
2. æŸ¥çœ‹å•†å“åº“å­˜
3. åˆ é™¤è¯¥é”€å”®è®°å½•
4. **éªŒè¯**ï¼šåº“å­˜åº”è¯¥æ¢å¤åˆ°é”€å”®å‰çš„æ•°é‡

### æµ‹è¯•2ï¼šå¯†ç åŠ å¯†
1. æŸ¥çœ‹æ•°æ®åº“ä¸­çš„ç”¨æˆ·å¯†ç å­—æ®µ
2. **éªŒè¯**ï¼šåº”è¯¥æ˜¯64ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆSHA-256ï¼‰
3. ä½¿ç”¨åŸå¯†ç ç™»å½•
4. **éªŒè¯**ï¼šåº”è¯¥èƒ½æ­£å¸¸ç™»å½•
5. æ·»åŠ æ–°ç”¨æˆ·
6. **éªŒè¯**ï¼šæ–°ç”¨æˆ·å¯†ç åº”è¯¥è‡ªåŠ¨åŠ å¯†

### æµ‹è¯•3ï¼šè¿›è´§æˆæœ¬ä»·
1. å•†å“Aï¼šåº“å­˜100ï¼Œæˆæœ¬ä»·50å…ƒ
2. è¿›è´§50åŒï¼Œæˆæœ¬ä»·60å…ƒ
3. **éªŒè¯**ï¼šæ–°æˆæœ¬ä»·åº”è¯¥æ˜¯53.33å…ƒï¼ˆåŠ æƒå¹³å‡ï¼‰
4. å†æ¬¡è¿›è´§100åŒï¼Œæˆæœ¬ä»·70å…ƒ
5. **éªŒè¯**ï¼šæˆæœ¬ä»·åº”è¯¥æ›´æ–°ä¸ºæ­£ç¡®çš„åŠ æƒå¹³å‡å€¼

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¯†ç è¿ç§»
- é¦–æ¬¡éƒ¨ç½²åï¼Œæ‰€æœ‰ç°æœ‰ç”¨æˆ·çš„å¯†ç ä¼šè‡ªåŠ¨åŠ å¯†
- ç”¨æˆ·æ— éœ€é‡æ–°è®¾ç½®å¯†ç 
- åŸå¯†ç ä»ç„¶å¯ä»¥æ­£å¸¸ç™»å½•

### 2. æ•°æ®å¤‡ä»½
- å»ºè®®åœ¨éƒ¨ç½²å‰è¿›è¡Œå®Œæ•´çš„æ•°æ®å¤‡ä»½
- ç‰¹åˆ«æ˜¯ç”¨æˆ·æ•°æ®å’Œé”€å”®è®°å½•

### 3. æˆæœ¬ä»·å˜åŒ–
- éƒ¨ç½²åï¼Œè¿›è´§æ—¶æˆæœ¬ä»·çš„è®¡ç®—æ–¹å¼ä¼šæ”¹å˜
- å»ºè®®é€šçŸ¥åº—é•¿æ–°çš„æˆæœ¬ä»·è®¡ç®—é€»è¾‘
- å¯ä»¥åœ¨è¿›è´§æ—¶æ˜¾ç¤ºæˆæœ¬ä»·å˜åŒ–

---

## ğŸ“Š å½±å“è¯„ä¼°

| é—®é¢˜ | ä¿®å¤å‰é£é™© | ä¿®å¤åæ•ˆæœ | ä¼˜å…ˆçº§ |
|------|-----------|-----------|--------|
| åˆ é™¤é”€å”®è®°å½•åº“å­˜æœªæ¢å¤ | ğŸ”´ é«˜ - åº“å­˜æ•°æ®é”™è¯¯ | âœ… åº“å­˜è‡ªåŠ¨æ¢å¤ | P0 |
| å¯†ç æ˜æ–‡å­˜å‚¨ | ğŸ”´ é«˜ - å®‰å…¨éšæ‚£ | âœ… SHA-256åŠ å¯† | P0 |
| æˆæœ¬ä»·ç›´æ¥è¦†ç›– | ğŸŸ¡ ä¸­ - è´¢åŠ¡ä¸å‡†ç¡® | âœ… åŠ æƒå¹³å‡è®¡ç®— | P1 |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **æäº¤ä»£ç åˆ° GitHub**
   ```bash
   git add .
   git commit -m "fix: ä¿®å¤ä¸¥é‡é—®é¢˜ - åº“å­˜æ¢å¤ã€å¯†ç åŠ å¯†ã€æˆæœ¬ä»·è®¡ç®—"
   git push origin main
   ```

2. **Vercel è‡ªåŠ¨éƒ¨ç½²**
   - æ¨é€å Vercel ä¼šè‡ªåŠ¨éƒ¨ç½²
   - ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆçº¦2-3åˆ†é’Ÿï¼‰

3. **éªŒè¯ä¿®å¤**
   - æµ‹è¯•åˆ é™¤é”€å”®è®°å½•åŠŸèƒ½
   - æµ‹è¯•ç™»å½•åŠŸèƒ½ï¼ˆå¯†ç åŠ å¯†ï¼‰
   - æµ‹è¯•è¿›è´§åŠŸèƒ½ï¼ˆæˆæœ¬ä»·è®¡ç®—ï¼‰

4. **é€šçŸ¥ç”¨æˆ·**
   - å‘ŠçŸ¥åº—é•¿ç³»ç»Ÿå·²æ›´æ–°
   - è¯´æ˜æ–°çš„æˆæœ¬ä»·è®¡ç®—æ–¹å¼
   - ç¡®è®¤æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **åº“å­˜é¢„è­¦**ï¼šåº“å­˜ä½äºé˜ˆå€¼æ—¶è‡ªåŠ¨æé†’
2. **æˆæœ¬ä»·å†å²**ï¼šè®°å½•æˆæœ¬ä»·å˜åŒ–å†å²
3. **å¯†ç å¼ºåº¦**ï¼šå¢åŠ å¯†ç å¼ºåº¦éªŒè¯
4. **æ“ä½œæ—¥å¿—**ï¼šè®°å½•å…³é”®æ“ä½œï¼ˆåˆ é™¤ã€ä¿®æ”¹ç­‰ï¼‰
5. **æ•°æ®å®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§

---

ä¿®å¤å®Œæˆæ—¶é—´ï¼š2025-01-01
ä¿®å¤äººå‘˜ï¼šAI Assistant
ç‰ˆæœ¬ï¼šv1.1.0

