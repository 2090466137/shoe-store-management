# 员工权限和退换货功能优化

## 修改日期
2025年12月31日

## 修改内容

### 问题一：员工账户删除会员权限限制

#### 问题描述
员工账户具有删除会员的功能，这不符合权限管理要求。只有店长应该有权限删除会员。

#### 解决方案

1. **添加会员删除权限定义** (`src/stores/user.js`)
   - 在 `PERMISSIONS` 对象中添加了 `MEMBER_DELETE: 'member:delete'` 权限
   - 该权限仅授予店长角色 (`ROLES.MANAGER`)
   - 员工角色 (`ROLES.STAFF`) 不包含此权限

2. **更新会员管理页面权限检查** (`src/views/Members.vue`)
   - 添加了 `canDeleteMember` 计算属性，检查当前用户是否有 `MEMBER_DELETE` 权限
   - 删除按钮现在只在有权限时显示：`v-if="canDeleteMember"`
   - 员工登录时将看不到删除按钮

#### 权限对比

**店长权限（ROLES.MANAGER）：**
- ✅ 查看会员 (MEMBER_VIEW)
- ✅ 添加会员 (MEMBER_ADD)
- ✅ 编辑会员 (MEMBER_EDIT)
- ✅ **删除会员 (MEMBER_DELETE)** ⭐ 独有
- ✅ 会员充值 (MEMBER_RECHARGE)

**员工权限（ROLES.STAFF）：**
- ✅ 查看会员 (MEMBER_VIEW)
- ✅ 添加会员 (MEMBER_ADD)
- ❌ 编辑会员 (MEMBER_EDIT) - 无权限
- ❌ **删除会员 (MEMBER_DELETE)** - 无权限 ⭐ 新增限制
- ✅ 会员充值 (MEMBER_RECHARGE)

---

### 问题二：退换货功能简化

#### 问题描述
退换货功能中有"处理人"字段，需要手动选择处理人，增加了操作步骤。实际使用中不需要此字段，应该直接进行退换货操作。

#### 解决方案

完全移除了退换货功能中的"处理人"相关代码 (`src/views/Returns.vue`)：

1. **删除UI组件**
   - 移除了"处理人"表单字段
   - 移除了处理人选择器弹窗 (`van-popup` + `van-picker`)
   - 移除了退换货记录列表中的"处理人"显示

2. **删除数据和逻辑**
   - 移除了 `handler` ref 变量
   - 移除了 `showHandlerPicker` ref 变量
   - 移除了 `salespersons` 数组（处理人列表）
   - 移除了 `onHandlerConfirm` 方法
   - 从退换货记录对象中移除了 `handler` 字段
   - 更新了 `canSubmit` 计算属性，移除了对 `handler` 的检查
   - 更新了 `closeForm` 方法，移除了 `handler` 的重置

3. **操作流程简化**

**修改前：**
1. 选择退货/换货类型
2. 选择原订单
3. 选择退换货商品
4. 输入退换货原因
5. **选择处理人** ❌ 多余步骤
6. 确认提交

**修改后：**
1. 选择退货/换货类型
2. 选择原订单
3. 选择退换货商品
4. 输入退换货原因
5. 确认提交 ✅ 直接操作

---

## 影响范围

### 修改的文件
1. `src/stores/user.js` - 权限定义和角色权限映射
2. `src/views/Members.vue` - 会员管理页面权限检查
3. `src/views/Returns.vue` - 退换货功能简化

### 兼容性
- ✅ 现有数据完全兼容
- ✅ 不影响其他功能
- ✅ 员工账户可以正常使用其他会员管理功能（查看、添加、充值）
- ✅ 现有的退换货记录仍然可以正常显示（即使包含 `handler` 字段）

---

## 测试建议

### 测试场景一：员工权限测试
1. 使用员工账户登录（用户名：`lhp`，密码：`123456`）
2. 进入"会员管理"页面
3. **预期结果**：
   - ✅ 可以查看会员列表
   - ✅ 可以点击"+"添加新会员
   - ✅ 可以进行会员充值
   - ❌ **看不到删除按钮**（红色垃圾桶图标）

### 测试场景二：店长权限测试
1. 使用店长账户登录（用户名：`luhongpeng`，密码：`lu17303838326`）
2. 进入"会员管理"页面
3. **预期结果**：
   - ✅ 可以查看会员列表
   - ✅ 可以添加新会员
   - ✅ 可以进行会员充值
   - ✅ **可以看到并使用删除按钮**

### 测试场景三：退换货功能测试
1. 进入"退换货管理"页面
2. 点击"新建退换货"
3. 选择退货或换货类型
4. 填写退换货信息
5. **预期结果**：
   - ✅ 不再显示"处理人"选择字段
   - ✅ 填写完退换货原因后可以直接提交
   - ✅ 退换货记录列表中不再显示"处理人"信息
   - ✅ 操作更加简洁快速

---

## 代码变更摘要

### src/stores/user.js
```javascript
// 新增权限定义
MEMBER_DELETE: 'member:delete',     // 删除会员

// 员工权限列表（不包含 MEMBER_DELETE）
[ROLES.STAFF]: [
  PERMISSIONS.MEMBER_VIEW,
  PERMISSIONS.MEMBER_ADD,
  PERMISSIONS.MEMBER_RECHARGE,
  // 注意：员工没有 MEMBER_EDIT 和 MEMBER_DELETE 权限
]
```

### src/views/Members.vue
```javascript
// 新增权限检查
const canDeleteMember = computed(() => 
  userStore.hasPermission(PERMISSIONS.MEMBER_DELETE)
)

// 删除按钮条件渲染
<van-icon 
  v-if="canDeleteMember"
  name="delete-o" 
  class="delete-btn"
  @click="handleDeleteMember(member, $event)"
/>
```

### src/views/Returns.vue
```javascript
// 移除的变量和方法
- const handler = ref('')
- const showHandlerPicker = ref(false)
- const salespersons = [...]
- const onHandlerConfirm = ({ selectedOptions }) => {...}

// 移除的UI组件
- 处理人表单字段
- 处理人选择器弹窗
- 退换货记录中的处理人显示

// 简化的验证逻辑
const canSubmit = computed(() => {
  // 移除了 !handler.value 的检查
  if (!selectedSale.value || !selectedProduct.value || !returnReason.value) {
    return false
  }
  // ...
})
```

---

## 总结

本次优化主要解决了两个问题：

1. **安全性提升**：通过细化权限控制，确保只有店长可以删除会员，防止误操作和数据丢失
2. **用户体验优化**：简化退换货流程，移除不必要的"处理人"选择步骤，提高操作效率

这些改进使系统更加符合实际业务需求，提高了系统的安全性和易用性。

